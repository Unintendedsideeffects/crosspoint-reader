<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrossPoint Reader - Web Tools</title>
    <style>
      :root {
        --blk: #111;
        --dk: #333;
        --md: #666;
        --bone: #cfcfcf;
        --fog: #ececec;
        --paper: #f3f1ed;
        --white: #fafafa;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: var(--paper);
        color: var(--blk);
        line-height: 1.45;
        background-image:
          repeating-linear-gradient(0deg, transparent, transparent 7px, rgba(0, 0, 0, 0.02) 7px, rgba(0, 0, 0, 0.02) 8px),
          repeating-linear-gradient(90deg, transparent, transparent 7px, rgba(0, 0, 0, 0.02) 7px, rgba(0, 0, 0, 0.02) 8px);
      }

      .page {
        max-width: 920px;
        margin: 0 auto;
        padding: 28px 16px 56px;
      }

      .header {
        border: 2px solid var(--blk);
        background: var(--white);
        padding: 20px 18px;
        margin-bottom: 14px;
      }

      .header h1 {
        margin: 0;
        font-size: clamp(20px, 3.5vw, 32px);
        letter-spacing: 0.04em;
      }

      .header p {
        margin: 8px 0 0;
        color: var(--dk);
        font-size: 13px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 10px;
      }

      .card {
        border: 2px solid var(--blk);
        background: var(--white);
        padding: 14px;
      }

      .card h2 {
        margin: 0;
        font-size: 15px;
        letter-spacing: 0.04em;
      }

      .card p {
        margin: 8px 0 0;
        color: var(--md);
        font-size: 12px;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .btn {
        border: 2px solid var(--blk);
        padding: 7px 11px;
        text-decoration: none;
        color: var(--blk);
        background: var(--white);
        font-size: 12px;
        cursor: pointer;
      }

      .btn:hover {
        background: var(--fog);
      }

      .btn-solid {
        background: var(--blk);
        color: var(--white);
      }

      .btn-solid:hover {
        background: var(--dk);
      }

      .device-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .device-input {
        min-width: 210px;
        background: var(--fog);
        border: 2px solid var(--dk);
        padding: 7px 9px;
        font-family: inherit;
        font-size: 12px;
        color: var(--blk);
      }

      .device-input:focus {
        outline: none;
        border-color: var(--blk);
      }

      .status {
        margin-top: 10px;
        padding: 8px 10px;
        border-left: 3px solid var(--blk);
        font-size: 12px;
        color: var(--dk);
        background: var(--fog);
      }

      .footer {
        margin-top: 16px;
        font-size: 11px;
        color: var(--md);
      }

      code {
        background: var(--fog);
        border: 1px solid var(--bone);
        padding: 0 4px;
      }

      @media (max-width: 560px) {
        .device-input {
          min-width: 100%;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="header">
        <h1>CrossPoint Reader</h1>
        <p>Unified web entry for build configuration, USB flashing tools, and local file manager access.</p>
      </header>

      <section class="grid">
        <article class="card">
          <h2>Build Configurator</h2>
          <p>Feature picker, size estimator, and GitHub custom-build launcher.</p>
          <div class="actions">
            <a class="btn btn-solid" href="./configurator/">Open Configurator</a>
          </div>
        </article>

        <article class="card">
          <h2>USB Serial Tools (Upstream)</h2>
          <p>Use the maintained Xteink web tools for flashing and serial-debug operations.</p>
          <div class="actions">
            <a class="btn btn-solid" href="https://xteink.dve.al/" target="_blank" rel="noopener">Open Xteink Flash</a>
            <a class="btn" href="https://xteink.dve.al/debug" target="_blank" rel="noopener">Open Xteink Debug</a>
          </div>
        </article>
      </section>

      <section class="card" style="margin-top: 10px;">
        <h2>Local File Manager</h2>
        <p>
          Best-effort probe for a running CrossPoint server, then open <code>/files</code>.
          Enter <code>crosspoint.local</code> or a device IP.
        </p>
        <div class="device-inline">
          <input
            id="file-manager-host"
            class="device-input"
            type="text"
            placeholder="crosspoint.local or 192.168.1.123"
            aria-label="CrossPoint host"
          />
          <button class="btn" id="detect-file-manager">Detect</button>
          <a class="btn" id="open-detected-file-manager" href="http://crosspoint.local/files" target="_blank" rel="noopener">
            Open /files
          </a>
        </div>
        <div id="file-manager-status" class="status">Not checked yet.</div>
      </section>

      <div class="footer">
        Note: if this page is served via HTTPS, active probing of <code>http://</code> local endpoints may be blocked by browser mixed-content policy.
      </div>
    </div>

    <script>
      function normalizeFileManagerOrigin(rawValue, defaultScheme = "http") {
        const raw = (rawValue || "").trim();
        if (!raw) return null;
        const withScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(raw) ? raw : `${defaultScheme}://${raw}`;
        try {
          const parsed = new URL(withScheme);
          if (!/^https?:$/.test(parsed.protocol)) return null;
          return parsed.origin;
        } catch (_) {
          return null;
        }
      }

      function shouldSkipProbe(origin) {
        if (!origin) return true;
        try {
          const target = new URL(origin);
          return location.protocol === "https:" && target.protocol === "http:";
        } catch (_) {
          return true;
        }
      }

      async function probeOrigin(origin, timeoutMs = 1200) {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        try {
          await fetch(`${origin}/api/status`, {
            method: "GET",
            cache: "no-store",
            mode: "no-cors",
            signal: controller.signal,
          });
          return true;
        } catch (_) {
          return false;
        } finally {
          clearTimeout(timer);
        }
      }

      function setStatus(message, isError = false) {
        const status = document.getElementById("file-manager-status");
        status.textContent = message;
        status.style.borderLeftColor = isError ? "var(--md)" : "var(--blk)";
      }

      function setDetectedUrl(origin) {
        const link = document.getElementById("open-detected-file-manager");
        link.href = `${origin}/files`;
      }

      function buildProbeOrigins(hostValue) {
        const origins = [];
        const addOrigin = (origin) => {
          if (!origin) return;
          if (!origins.includes(origin)) origins.push(origin);
        };

        const preferredScheme = location.protocol === "https:" ? "https" : "http";
        const alternateScheme = preferredScheme === "https" ? "http" : "https";
        const appendInputOrigins = (value) => {
          const raw = (value || "").trim();
          if (!raw) return;
          const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(raw);
          if (hasScheme) {
            addOrigin(normalizeFileManagerOrigin(raw));
            return;
          }
          addOrigin(normalizeFileManagerOrigin(raw, preferredScheme));
          addOrigin(normalizeFileManagerOrigin(raw, alternateScheme));
        };

        appendInputOrigins(hostValue);
        appendInputOrigins(new URLSearchParams(location.search).get("host"));
        addOrigin("http://crosspoint.local");
        addOrigin("https://crosspoint.local");

        const localHostPattern = /(^localhost$)|(^127\.)|(^10\.)|(^192\.168\.)|(^172\.(1[6-9]|2[0-9]|3[0-1])\.)|(\.local$)/;
        if (localHostPattern.test(location.hostname)) {
          addOrigin(location.origin);
        }

        return origins;
      }

      async function detectFileManager() {
        const hostInput = document.getElementById("file-manager-host");
        const inputOrigin = normalizeFileManagerOrigin(hostInput.value);
        if (hostInput.value.trim() && !inputOrigin) {
          setStatus("Invalid host. Use crosspoint.local, 192.168.x.x, or a full http(s) URL.", true);
          return;
        }

        const candidates = buildProbeOrigins(hostInput.value);
        if (inputOrigin) setDetectedUrl(inputOrigin);
        setStatus(`Probing ${candidates.length} candidate endpoint(s)...`);

        let skippedMixedContent = false;
        let firstSkippedOrigin = null;
        for (const origin of candidates) {
          if (shouldSkipProbe(origin)) {
            skippedMixedContent = true;
            if (!firstSkippedOrigin) firstSkippedOrigin = origin;
            continue;
          }
          if (await probeOrigin(origin)) {
            setDetectedUrl(origin);
            setStatus(`Detected endpoint at ${origin}.`);
            return;
          }
        }

        setDetectedUrl(firstSkippedOrigin || inputOrigin || "http://crosspoint.local");
        if (skippedMixedContent) {
          setStatus(
            `Active probing is blocked by browser mixed-content policy on HTTPS pages for ${firstSkippedOrigin || "http:// hosts"}. Use Open /files to navigate directly, or run this page from http:// for active probing.`,
            true
          );
        } else {
          setStatus("No running file manager detected. Try entering the device IP manually.", true);
        }
      }

      function setup() {
        const detectBtn = document.getElementById("detect-file-manager");
        const hostInput = document.getElementById("file-manager-host");
        if (!detectBtn || !hostInput) return;

        detectBtn.addEventListener("click", detectFileManager);
        hostInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            detectFileManager();
          }
        });
      }

      setup();
    </script>
  </body>
</html>
