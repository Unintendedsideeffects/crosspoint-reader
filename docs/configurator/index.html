<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrossPoint Reader - Skill Tree</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&family=IBM+Plex+Mono:wght@400;500&family=Source+Sans+3:wght@400;500;600&display=swap");

      :root {
        --ink: #111111;
        --ink-mid: #3d3d3d;
        --ink-light: #5b5b5b;
        --ink-faint: #777777;
        --paper: #efefeb;
        --paper-warm: #e6e6e0;
        --paper-bright: #f9f9f4;
        --active-fill: #1f1f1f;
        --active-stroke: #111111;
        --locked-fill: #ddddd7;
        --locked-stroke: #8a8a82;
        --locked-text: #74746e;
        --bar-fill: linear-gradient(90deg, #111111 0%, #4b4b4b 100%);
        --bar-track: #cacac3;
        --border: #7a7a72;
        --border-light: #afafa7;
        --radius: 12px;
        --shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
        --constellation-glow: 0 0 0 rgba(0, 0, 0, 0);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Source Sans 3', sans-serif;
        background:
          radial-gradient(130% 95% at 50% -8%, #ffffff 0%, #f3f3ee 52%, #ecece6 100%),
          repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.014) 0px,
            rgba(0, 0, 0, 0.014) 1px,
            transparent 1px,
            transparent 3px
          );
        color: var(--ink);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
      }

      .page {
        max-width: 1180px;
        margin: 0 auto;
        padding: 40px 20px 80px;
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 36px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-light);
      }

      .header-eyebrow {
        font-family: 'IBM Plex Mono', monospace;
        letter-spacing: 0.34em;
        text-transform: uppercase;
        font-size: 0.64rem;
        color: var(--ink-light);
        margin-bottom: 8px;
      }

      .header h1 {
        font-family: 'Cinzel', serif;
        font-weight: 700;
        font-size: clamp(2.1rem, 4.2vw, 3.2rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--ink);
        text-shadow: none;
      }

      .header-sub {
        color: var(--ink-mid);
        font-size: 0.95rem;
        margin-top: 10px;
        font-weight: 400;
      }

      /* Flash meter */
      .flash-meter {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 18px;
        background: var(--paper-bright);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 20px;
        flex-wrap: wrap;
        box-shadow: var(--shadow);
      }

      .flash-label {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.65rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--ink-light);
      }

      .flash-value {
        font-family: 'Cinzel', serif;
        font-size: 1.55rem;
        font-weight: 700;
        color: var(--ink);
        min-width: 70px;
        letter-spacing: 0.04em;
      }

      .flash-track {
        flex: 1;
        min-width: 180px;
        height: 8px;
        background: var(--bar-track);
        border-radius: 99px;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.06);
      }

      .flash-fill {
        height: 100%;
        background: var(--bar-fill);
        border-radius: 99px;
        transition: width 0.35s ease;
      }

      .flash-fill.over {
        background: repeating-linear-gradient(
          45deg,
          #222 0px,
          #222 4px,
          #555 4px,
          #555 8px
        );
      }

      .flash-context {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.72rem;
        color: var(--ink-light);
      }

      /* Loadout / profiles */
      .loadout-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
        flex-wrap: wrap;
      }

      .loadout-label {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.65rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--ink-mid);
        margin-right: 4px;
      }

      .preset-btn {
        background: var(--paper-bright);
        border: 1px solid var(--border);
        color: var(--ink);
        padding: 6px 15px;
        border-radius: 6px;
        font-family: 'Cinzel', serif;
        font-size: 0.82rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.18s ease;
      }

      .preset-btn:hover {
        border-color: var(--active-stroke);
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.16);
      }

      .preset-btn.active {
        background: linear-gradient(180deg, #2b2b2b 0%, #151515 100%);
        color: #f3f3ef;
        border-color: #101010;
      }

      .profile-status {
        font-size: 0.78rem;
        color: var(--ink-light);
        margin-bottom: 28px;
      }

      .profile-status strong {
        color: var(--ink);
        font-weight: 600;
      }

      /* Skill Graph */
      .skill-tree {
        margin-bottom: 36px;
        padding: 30px 20px 20px;
        background:
          linear-gradient(180deg, #f8f8f3 0%, #ecece5 100%);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .skill-tree::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.24;
        background-image:
          radial-gradient(circle at 14% 22%, rgba(0, 0, 0, 0.16) 0, rgba(0, 0, 0, 0.16) 1px, transparent 2px),
          radial-gradient(circle at 69% 17%, rgba(0, 0, 0, 0.12) 0, rgba(0, 0, 0, 0.12) 1px, transparent 2px),
          radial-gradient(circle at 41% 64%, rgba(0, 0, 0, 0.11) 0, rgba(0, 0, 0, 0.11) 1px, transparent 2px),
          radial-gradient(circle at 86% 53%, rgba(0, 0, 0, 0.12) 0, rgba(0, 0, 0, 0.12) 1px, transparent 2px);
      }

      .skill-tree::after {
        content: "";
        position: absolute;
        inset: 6px;
        border: 1px solid rgba(0, 0, 0, 0.12);
        border-radius: 12px;
        pointer-events: none;
      }

      .graph-links {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
      }

      .graph-edge {
        stroke: rgba(0, 0, 0, 0.24);
        stroke-width: 1.4;
        stroke-linecap: round;
        transition: stroke 0.2s ease;
      }

      .graph-edge.active {
        stroke: #101010;
        stroke-width: 2;
        filter: none;
      }

      .graph-edge.locked {
        stroke: var(--locked-stroke);
        stroke-dasharray: 3 4;
      }

      .graph-layout {
        position: relative;
        z-index: 1;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 18px 14px;
        align-items: start;
      }

      .graph-root {
        grid-column: 1 / -1;
        justify-self: center;
        margin-bottom: 2px;
      }

      .graph-hub {
        justify-self: center;
      }

      .graph-lane {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .lane-header {
        font-family: 'Cinzel', serif;
        font-size: 0.68rem;
        font-weight: 600;
        letter-spacing: 0.24em;
        text-transform: uppercase;
        color: #2d2d2d;
        margin-bottom: 4px;
        text-shadow: none;
      }

      /* Node */
      .skill-node,
      .anchor-node {
        position: relative;
        width: 100%;
        max-width: 150px;
        cursor: pointer;
        -webkit-user-select: none;
        user-select: none;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .anchor-node {
        cursor: default;
      }

      .skill-node input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
      }

      .node-ring {
        width: 58px;
        height: 58px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.32);
        background: radial-gradient(circle at 35% 25%, #ffffff 0%, #ecece7 58%, #dbdbd4 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.24s ease;
        position: relative;
        margin-bottom: 6px;
        box-shadow:
          inset 0 0 0 1px rgba(255, 255, 255, 0.42),
          0 3px 7px rgba(0, 0, 0, 0.12);
      }

      .node-ring::after {
        content: "";
        position: absolute;
        inset: 6px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.13);
      }

      .graph-root .node-ring {
        width: 72px;
        height: 72px;
        border-color: #111111;
        background: radial-gradient(circle at 36% 24%, #ffffff 0%, #ebebe6 58%, #d7d7d0 100%);
      }

      .graph-root .node-size {
        color: #202020;
      }

      .graph-hub .node-ring {
        width: 52px;
        height: 52px;
      }

      .node-icon {
        font-size: 1.05rem;
        line-height: 1;
        color: #2a2a2a;
        text-shadow: none;
        transition: all 0.25s ease;
        z-index: 1;
      }

      .skill-node.active .node-ring,
      .anchor-node.active .node-ring {
        background: radial-gradient(circle at 32% 22%, #ffffff 0%, #e8e8e2 54%, #d2d2cb 100%);
        border-color: var(--active-stroke);
        box-shadow:
          inset 0 0 0 2px rgba(0, 0, 0, 0.09),
          0 0 0 1px rgba(0, 0, 0, 0.12);
      }

      .skill-node.active .node-icon,
      .anchor-node.active .node-icon {
        color: #101010;
      }

      .skill-node.locked .node-ring {
        background: radial-gradient(circle at 35% 25%, #e5e5de 0%, #d7d7cf 100%);
        border-color: var(--locked-stroke);
        border-style: dashed;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.08);
      }

      .skill-node.locked .node-icon {
        color: var(--locked-text);
        font-size: 0.82rem;
        text-shadow: none;
      }

      .node-label {
        text-align: center;
        font-size: 0.73rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #424242;
        line-height: 1.2;
        transition: color 0.2s ease;
      }

      .skill-node.active .node-label,
      .anchor-node.active .node-label {
        color: #101010;
        text-shadow: none;
      }

      .skill-node.locked .node-label {
        color: var(--locked-text);
      }

      .node-size {
        text-align: center;
        font-size: 0.62rem;
        font-family: 'IBM Plex Mono', monospace;
        color: #666660;
        margin-top: 1px;
      }

      .skill-node.active .node-size,
      .anchor-node.active .node-size {
        color: #202020;
      }

      .skill-node.dependent-node {
        transform: translateX(14px);
      }

      /* Tooltip */
      .skill-node .tooltip {
        position: absolute;
        bottom: calc(100% + 6px);
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(180deg, #fcfcf7 0%, #efefe8 100%);
        border: 1px solid #8c8c84;
        border-radius: 8px;
        padding: 11px 12px;
        min-width: 190px;
        max-width: 240px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.12s ease;
        z-index: 100;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      .skill-node:hover .tooltip {
        opacity: 1;
      }

      .tooltip-title {
        font-family: 'Cinzel', serif;
        font-weight: 700;
        font-size: 0.8rem;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        color: #111111;
        margin-bottom: 3px;
      }

      .tooltip-desc {
        font-size: 0.75rem;
        color: #353535;
        line-height: 1.4;
        margin-bottom: 4px;
      }

      .tooltip-size {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.68rem;
        color: #282828;
      }

      .tooltip-req {
        font-size: 0.68rem;
        color: #555555;
        margin-top: 3px;
        font-style: italic;
      }

      .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: #8c8c84;
      }

      /* Panels */
      .panel {
        background: var(--paper-bright);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px 19px;
        margin-bottom: 14px;
        box-shadow: var(--shadow);
      }

      .panel-heading {
        font-family: 'Cinzel', serif;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: #252525;
        margin-bottom: 12px;
      }

      .outputs-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .output { margin-bottom: 0; }

      .output-label {
        font-size: 0.72rem;
        font-weight: 500;
        color: #4a4a4a;
        margin-bottom: 4px;
      }

      .output textarea {
        width: 100%;
        min-height: 72px;
        background: #f3f3ed;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        padding: 8px 10px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.72rem;
        color: #1c1c1c;
        resize: vertical;
      }

      .output textarea:focus {
        outline: none;
        border-color: #181818;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.12);
      }

      .actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .btn {
        border: none;
        border-radius: 6px;
        padding: 7px 13px;
        font-family: 'Source Sans 3', sans-serif;
        font-size: 0.78rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.18s ease;
        text-decoration: none;
        text-align: center;
      }

      .btn-outline {
        background: #f1f1eb;
        color: #1e1e1e;
        border: 1px solid var(--border);
      }

      .btn-outline:hover {
        border-color: #111111;
        color: #111111;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.16);
      }

      .btn-outline.copied {
        background: #2b2b2b;
        color: #f5f5f1;
        border-color: #111111;
      }

      .btn-solid {
        background: linear-gradient(180deg, #2d2d2d 0%, #151515 100%);
        color: #f5f5f1;
        border: 1px solid #111111;
      }

      .btn-solid:hover {
        filter: brightness(1.04);
      }

      .info-bar {
        margin-top: 10px;
        padding: 8px 12px;
        border-left: 2px solid #1f1f1f;
        font-size: 0.78rem;
        color: #434343;
        font-style: italic;
        background: rgba(0, 0, 0, 0.04);
        border-radius: 0 6px 6px 0;
      }

      /* Companion */
      .companion-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        flex-wrap: wrap;
      }

      .companion-title {
        font-weight: 600;
        font-size: 0.88rem;
      }

      .companion-desc {
        font-size: 0.78rem;
        color: #4b4b4b;
        margin-top: 3px;
      }

      .companion-desc code {
        background: #e8e8e2;
        padding: 1px 4px;
        border-radius: 2px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.7rem;
      }

      /* Preview */
      .preview-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .preview-sub {
        font-size: 0.78rem;
        color: #4d4d4d;
        margin-top: 3px;
      }

      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 10px;
      }

      .preview-card {
        border: 1px solid var(--border-light);
        border-radius: 8px;
        overflow: hidden;
        background: #f6f6f0;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.14);
      }

      .preview-card img {
        width: 100%;
        height: auto;
        display: block;
      }

      .preview-card figcaption {
        padding: 6px 8px;
        font-size: 0.72rem;
        color: #3e3e3e;
      }

      .preview-meta {
        margin-top: 8px;
        font-size: 0.7rem;
        color: #666666;
      }

      .footer {
        text-align: center;
        margin-top: 24px;
        font-size: 0.75rem;
        color: #5f5f5f;
      }

      /* Responsive */
      @media (max-width: 800px) {
        .graph-layout {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 16px 10px;
        }
        .graph-root {
          margin-bottom: 8px;
        }
        .graph-hub {
          margin-bottom: 4px;
        }
        .skill-node.dependent-node {
          transform: translateX(10px);
        }
        .outputs-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .graph-layout {
          grid-template-columns: 1fr;
          gap: 14px;
        }
        .graph-root {
          justify-self: center;
        }
        .graph-hub {
          justify-self: center;
        }
        .graph-lane {
          gap: 10px;
        }
        .skill-node.dependent-node {
          transform: translateX(0);
        }
        .flash-meter {
          flex-direction: column;
          align-items: stretch;
        }
      }

      /* Hover ring effect */
      .skill-node:not(.locked):hover .node-ring {
        border-color: #111111;
        box-shadow:
          inset 0 0 0 1px rgba(0, 0, 0, 0.12),
          0 2px 6px rgba(0, 0, 0, 0.16);
      }

      .skill-node.active:hover .node-ring {
        box-shadow:
          inset 0 0 0 2px rgba(0, 0, 0, 0.16),
          0 3px 7px rgba(0, 0, 0, 0.2);
      }

      /* Note style */
      .note-bar {
        padding: 8px 12px;
        border-left: 2px solid #1f1f1f;
        font-size: 0.78rem;
        color: #434343;
        margin-top: 10px;
        font-style: italic;
        background: rgba(0, 0, 0, 0.04);
        border-radius: 0 6px 6px 0;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <div class="header-eyebrow">CrossPoint Reader</div>
        <h1>E-Ink Skill Graph</h1>
        <div class="header-sub">
          Shape your firmware graph in a high-contrast e-ink style within the 6.4 MB flash limit.
        </div>
      </div>

      <!-- Flash meter -->
      <div class="flash-meter">
        <span class="flash-label">Flash</span>
        <span class="flash-value" id="size-value">6.0 MB</span>
        <div class="flash-track">
          <div class="flash-fill" id="size-bar" style="width: 0%"></div>
        </div>
        <span class="flash-context" id="size-context">94% of 6.4 MB</span>
      </div>

      <!-- Loadout -->
      <div class="loadout-bar">
        <span class="loadout-label">Loadout</span>
        <button class="preset-btn" data-preset="lean">Lean</button>
        <button class="preset-btn active" data-preset="standard">Standard</button>
        <button class="preset-btn" data-preset="full">Full</button>
      </div>
      <div class="profile-status" id="profile-status"></div>

      <!-- Skill Tree -->
      <div class="skill-tree" id="skill-tree">
        <svg class="graph-links" id="graph-links" aria-hidden="true"></svg>
        <div class="graph-layout">
          <div class="graph-root anchor-node active" data-node-id="root">
            <div class="node-ring"><span class="node-icon">&#x1F5A5;</span></div>
            <div class="node-label">E-Ink Base</div>
            <div class="node-size">2.35 MB core</div>
          </div>

          <div class="graph-hub anchor-node" data-node-id="reading_hub">
            <div class="node-ring"><span class="node-icon">&#x1F4DA;</span></div>
            <div class="node-label">Reading</div>
          </div>
          <div class="graph-hub anchor-node" data-node-id="interface_hub">
            <div class="node-ring"><span class="node-icon">&#x1F58C;</span></div>
            <div class="node-label">Interface</div>
          </div>
          <div class="graph-hub anchor-node" data-node-id="network_hub">
            <div class="node-ring"><span class="node-icon">&#x1F6DC;</span></div>
            <div class="node-label">Network</div>
          </div>
          <div class="graph-hub anchor-node" data-node-id="extras_hub">
            <div class="node-ring"><span class="node-icon">&#x2726;</span></div>
            <div class="node-label">Extras</div>
          </div>

          <div class="graph-lane" data-lane="reading">
            <div class="lane-header">Reading</div>

            <label class="skill-node" data-feature="epub_support" data-node-id="epub_support">
              <input type="checkbox" id="epub_support" data-feature="epub_support" />
              <div class="tooltip">
                <div class="tooltip-title">EPUB Support</div>
                <div class="tooltip-desc">EPUB e-book reader with CSS, images, and chapter navigation</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1F4D6;</span></div>
              <div class="node-label">EPUB</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node dependent-node" data-feature="hyphenation" data-node-id="hyphenation">
              <input type="checkbox" id="hyphenation" data-feature="hyphenation" />
              <div class="tooltip">
                <div class="tooltip-title">Hyphenation</div>
                <div class="tooltip-desc">Language-aware hyphenation for justified EPUB text</div>
                <div class="tooltip-size"></div>
                <div class="tooltip-req">Requires EPUB Support</div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2E17;</span></div>
              <div class="node-label">Hyphenation</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="markdown" data-node-id="markdown">
              <input type="checkbox" id="markdown" data-feature="markdown" />
              <div class="tooltip">
                <div class="tooltip-title">Markdown &amp; Obsidian</div>
                <div class="tooltip-desc">Markdown and Obsidian vault reading support</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x270D;</span></div>
              <div class="node-label">Markdown</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="xtc_support" data-node-id="xtc_support">
              <input type="checkbox" id="xtc_support" data-feature="xtc_support" />
              <div class="tooltip">
                <div class="tooltip-title">XTC Support</div>
                <div class="tooltip-desc">XTC format reader with chapter navigation</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1F4DC;</span></div>
              <div class="node-label">XTC</div>
              <div class="node-size"></div>
            </label>
          </div>

          <div class="graph-lane" data-lane="interface">
            <div class="lane-header">Interface</div>

            <label class="skill-node" data-feature="extended_fonts" data-node-id="extended_fonts">
              <input type="checkbox" id="extended_fonts" data-feature="extended_fonts" />
              <div class="tooltip">
                <div class="tooltip-title">Extended Fonts</div>
                <div class="tooltip-desc">12/16/18pt fonts and OpenDyslexic support</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1D5D4;</span></div>
              <div class="node-label">Fonts</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="lyra_theme" data-node-id="lyra_theme">
              <input type="checkbox" id="lyra_theme" data-feature="lyra_theme" />
              <div class="tooltip">
                <div class="tooltip-title">Lyra Theme</div>
                <div class="tooltip-desc">Alternative UI theme with refined spacing and layout</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2726;</span></div>
              <div class="node-label">Lyra Theme</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="home_media_picker" data-node-id="home_media_picker">
              <input type="checkbox" id="home_media_picker" data-feature="home_media_picker" />
              <div class="tooltip">
                <div class="tooltip-title">Home Media Picker</div>
                <div class="tooltip-desc">Streamlined home UI with horizontal book shelf + vertical menu</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1F3E0;</span></div>
              <div class="node-label">Home UI</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="image_sleep" data-node-id="image_sleep">
              <input type="checkbox" id="image_sleep" data-feature="image_sleep" />
              <div class="tooltip">
                <div class="tooltip-title">PNG/JPEG Sleep Images</div>
                <div class="tooltip-desc">PNG and JPEG sleep screen support (BMP always included)</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x263D;</span></div>
              <div class="node-label">Sleep Art</div>
              <div class="node-size"></div>
            </label>
          </div>

          <div class="graph-lane" data-lane="network">
            <div class="lane-header">Network</div>

            <label class="skill-node" data-feature="background_server" data-node-id="background_server">
              <input type="checkbox" id="background_server" data-feature="background_server" />
              <div class="tooltip">
                <div class="tooltip-title">Background Web Server</div>
                <div class="tooltip-desc">Background web server for file management</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1F310;</span></div>
              <div class="node-label">Web Server</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="ota_updates" data-node-id="ota_updates">
              <input type="checkbox" id="ota_updates" data-feature="ota_updates" />
              <div class="tooltip">
                <div class="tooltip-title">OTA Updates</div>
                <div class="tooltip-desc">Over-the-air firmware updates via WiFi</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2B06;</span></div>
              <div class="node-label">OTA</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="integrations" data-node-id="integrations">
              <input type="checkbox" id="integrations" data-feature="integrations" />
              <div class="tooltip">
                <div class="tooltip-title">Integrations Base</div>
                <div class="tooltip-desc">Shared runtime hooks for remote sync integrations</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1F517;</span></div>
              <div class="node-label">Integrations</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node dependent-node" data-feature="koreader_sync" data-node-id="koreader_sync">
              <input type="checkbox" id="koreader_sync" data-feature="koreader_sync" />
              <div class="tooltip">
                <div class="tooltip-title">KOReader Sync</div>
                <div class="tooltip-desc">Sync reading progress with KOReader</div>
                <div class="tooltip-size"></div>
                <div class="tooltip-req">Requires Integrations</div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1F4F1;</span></div>
              <div class="node-label">KOReader</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node dependent-node" data-feature="calibre_sync" data-node-id="calibre_sync">
              <input type="checkbox" id="calibre_sync" data-feature="calibre_sync" />
              <div class="tooltip">
                <div class="tooltip-title">Calibre Sync</div>
                <div class="tooltip-desc">Calibre OPDS browser and metadata sync settings</div>
                <div class="tooltip-size"></div>
                <div class="tooltip-req">Requires Integrations</div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x1F4DA;</span></div>
              <div class="node-label">Calibre</div>
              <div class="node-size"></div>
            </label>
          </div>

          <div class="graph-lane" data-lane="extras">
            <div class="lane-header">Extras</div>

            <label class="skill-node" data-feature="web_pokedex_plugin" data-node-id="web_pokedex_plugin">
              <input type="checkbox" id="web_pokedex_plugin" data-feature="web_pokedex_plugin" />
              <div class="tooltip">
                <div class="tooltip-title">Web Pokedex Plugin</div>
                <div class="tooltip-desc">Browser-side Pokemon wallpaper generator at /plugins/pokedex</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x26A1;</span></div>
              <div class="node-label">Pokedex</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="todo_planner" data-node-id="todo_planner">
              <input type="checkbox" id="todo_planner" data-feature="todo_planner" />
              <div class="tooltip">
                <div class="tooltip-title">Todo Planner</div>
                <div class="tooltip-desc">Daily markdown notes and task tracking</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2611;</span></div>
              <div class="node-label">Todo</div>
              <div class="node-size"></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Build Outputs -->
      <div class="panel">
        <div class="panel-heading">Build Output</div>
        <div class="outputs-grid">
          <div class="output">
            <div class="output-label">Build flags</div>
            <textarea id="flags-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">Generate command</div>
            <textarea id="command-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">platformio-custom.ini</div>
            <textarea id="ini-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">Share URL</div>
            <textarea id="share-output" readonly></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-outline" id="copy-command">Copy command</button>
          <button class="btn btn-outline" id="copy-flags">Copy flags</button>
          <button class="btn btn-outline" id="copy-share">Copy URL</button>
          <button class="btn btn-outline" id="download-ini">Download .ini</button>
          <a class="btn btn-solid" id="build-link" href="#" target="_blank" rel="noopener">Build on GitHub Actions</a>
        </div>
        <div class="info-bar">
          Dependencies are enforced automatically. Enabling a child skill unlocks its parent.
        </div>
      </div>

      <!-- Companion -->
      <div class="panel">
        <div class="panel-heading">Companion Plugins</div>
        <div class="companion-row">
          <div>
            <div class="companion-title">X4 Grayscale Pokedex Wallpaper</div>
            <div class="companion-desc">
              Generate wallpapers from Pokemon data. Upload to
              <code>/sleep/pokedex</code> for Sleep Source mode.
            </div>
          </div>
          <a class="btn btn-outline" href="../plugins/x4-pokedex-grayscale/" target="_blank" rel="noopener">Open Plugin</a>
        </div>
      </div>

      <!-- Preview -->
      <div class="panel">
        <div class="preview-top">
          <div>
            <div class="panel-heading" style="margin-bottom: 0">Live Screen Previews</div>
            <div class="preview-sub">Auto-generated from the latest firmware UI harness.</div>
          </div>
          <a class="btn btn-outline" href="./screen-previews/" target="_blank" rel="noopener">Open Folder</a>
        </div>
        <div class="preview-grid" id="preview-grid"></div>
        <div class="preview-meta" id="preview-meta"></div>
      </div>

      <div class="footer">Future roadmap: this picker will live inside the OTA update menu.</div>
    </div>

    <script>
      const FEATURES = {
        extended_fonts: {
          sizeKb: 3630,
          flag: "ENABLE_EXTENDED_FONTS",
          default: true,
        },
        image_sleep: {
          sizeKb: 0,
          flag: "ENABLE_IMAGE_SLEEP",
          default: true,
        },
        markdown: {
          sizeKb: 231,
          flag: "ENABLE_MARKDOWN",
          default: true,
        },
        integrations: {
          sizeKb: 0,
          flag: "ENABLE_INTEGRATIONS",
          default: false,
        },
        koreader_sync: {
          sizeKb: 142,
          flag: "ENABLE_KOREADER_SYNC",
          default: false,
        },
        calibre_sync: {
          sizeKb: 223,
          flag: "ENABLE_CALIBRE_SYNC",
          default: false,
        },
        background_server: {
          sizeKb: 0,
          flag: "ENABLE_BACKGROUND_SERVER",
          default: true,
        },
        home_media_picker: {
          sizeKb: -4,
          flag: "ENABLE_HOME_MEDIA_PICKER",
          default: true,
        },
        web_pokedex_plugin: {
          sizeKb: 4,
          flag: "ENABLE_WEB_POKEDEX_PLUGIN",
          default: false,
        },
        epub_support: {
          sizeKb: 157,
          flag: "ENABLE_EPUB_SUPPORT",
          default: true,
        },
        hyphenation: {
          sizeKb: 447,
          flag: "ENABLE_HYPHENATION",
          default: true,
        },
        xtc_support: {
          sizeKb: 13,
          flag: "ENABLE_XTC_SUPPORT",
          default: true,
        },
        lyra_theme: {
          sizeKb: 5,
          flag: "ENABLE_LYRA_THEME",
          default: true,
        },
        ota_updates: {
          sizeKb: 230,
          flag: "ENABLE_OTA_UPDATES",
          default: true,
        },
        todo_planner: {
          sizeKb: 6,
          flag: "ENABLE_TODO_PLANNER",
          default: false,
        },
      };

      const BASE_SIZE_MB = 1.66;
      const MAX_FLASH_MB = 6.4;
      const FEATURE_DEPENDENCIES = {
        koreader_sync: ["integrations"],
        calibre_sync: ["integrations"],
        hyphenation: ["epub_support"],
      };

      const HUB_FEATURES = {
        reading_hub: ["epub_support", "hyphenation", "markdown", "xtc_support"],
        interface_hub: ["extended_fonts", "lyra_theme", "home_media_picker", "image_sleep"],
        network_hub: ["background_server", "ota_updates", "integrations", "koreader_sync", "calibre_sync"],
        extras_hub: ["web_pokedex_plugin", "todo_planner"],
      };

      const GRAPH_EDGES = [
        { from: "root", to: "reading_hub" },
        { from: "root", to: "interface_hub" },
        { from: "root", to: "network_hub" },
        { from: "root", to: "extras_hub" },
        { from: "reading_hub", to: "epub_support" },
        { from: "epub_support", to: "hyphenation" },
        { from: "reading_hub", to: "markdown" },
        { from: "reading_hub", to: "xtc_support" },
        { from: "interface_hub", to: "extended_fonts" },
        { from: "interface_hub", to: "lyra_theme" },
        { from: "interface_hub", to: "home_media_picker" },
        { from: "interface_hub", to: "image_sleep" },
        { from: "network_hub", to: "background_server" },
        { from: "network_hub", to: "ota_updates" },
        { from: "network_hub", to: "integrations" },
        { from: "integrations", to: "koreader_sync" },
        { from: "integrations", to: "calibre_sync" },
        { from: "extras_hub", to: "web_pokedex_plugin" },
        { from: "extras_hub", to: "todo_planner" },
      ];

      const PROFILES = {
        lean: {},
        standard: {
          extended_fonts: true,
          image_sleep: true,
          epub_support: true,
          hyphenation: true,
          xtc_support: true,
          lyra_theme: true,
          ota_updates: true,
          background_server: true,
          home_media_picker: true,
        },
        full: {
          extended_fonts: true,
          image_sleep: true,
          markdown: true,
          integrations: true,
          koreader_sync: true,
          calibre_sync: true,
          epub_support: true,
          hyphenation: true,
          xtc_support: true,
          lyra_theme: true,
          ota_updates: true,
          todo_planner: true,
          background_server: true,
          home_media_picker: true,
          web_pokedex_plugin: true,
        },
      };

      let baseProfile = "standard";

      function getRepoInfo() {
        const host = window.location.hostname;
        const pathParts = window.location.pathname.split("/").filter(Boolean);
        if (host.endsWith("github.io") && pathParts.length > 0) {
          return { owner: host.split(".")[0], repo: pathParts[0] };
        }
        return { owner: "Unintendedsideeffects", repo: "crosspoint-reader" };
      }

      function parseBooleanParam(value) {
        if (value == null) return null;
        const normalized = value.toLowerCase();
        if (normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on") return true;
        if (normalized === "0" || normalized === "false" || normalized === "no" || normalized === "off") return false;
        return null;
      }

      function profileToSelections(name) {
        const profile = PROFILES[name] || {};
        const selections = {};
        Object.keys(FEATURES).forEach((feature) => {
          selections[feature] = Boolean(profile[feature]);
        });
        return selections;
      }

      function setSelections(selections) {
        Object.keys(FEATURES).forEach((feature) => {
          const checkbox = document.getElementById(feature);
          checkbox.checked = Boolean(selections[feature]);
        });
      }

      function enableDependencies(feature, selections) {
        const parents = FEATURE_DEPENDENCIES[feature] || [];
        parents.forEach((parent) => {
          if (!selections[parent]) {
            selections[parent] = true;
            enableDependencies(parent, selections);
          }
        });
      }

      function disableDependents(feature, selections) {
        Object.keys(FEATURE_DEPENDENCIES).forEach((child) => {
          const parents = FEATURE_DEPENDENCIES[child] || [];
          if (parents.includes(feature) && selections[child]) {
            selections[child] = false;
            disableDependents(child, selections);
          }
        });
      }

      function applyDependencyRules(selections, changedFeature, enabled) {
        if (changedFeature) {
          if (enabled) {
            enableDependencies(changedFeature, selections);
          } else {
            disableDependents(changedFeature, selections);
          }
        }
        Object.keys(FEATURE_DEPENDENCIES).forEach((child) => {
          const parents = FEATURE_DEPENDENCIES[child] || [];
          const missingParent = parents.some((parent) => !selections[parent]);
          if (missingParent) selections[child] = false;
        });
      }

      function highlightProfile(profileName) {
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.preset === profileName);
        });
      }

      function detectMatchingProfile(selections) {
        for (const [profileName] of Object.entries(PROFILES)) {
          const profileSelections = profileToSelections(profileName);
          const isMatch = Object.keys(FEATURES).every(
            (feature) => selections[feature] === profileSelections[feature]
          );
          if (isMatch) return profileName;
        }
        return null;
      }

      function applyProfile(name) {
        if (!PROFILES[name]) return;
        baseProfile = name;
        setSelections(profileToSelections(name));
        highlightProfile(name);
        updateAll();
      }

      function updateProfileStatus(matchingProfile) {
        const status = document.getElementById("profile-status");
        if (matchingProfile) {
          status.innerHTML = `Active loadout: <strong>${matchingProfile}</strong>`;
        } else {
          status.innerHTML = `Active loadout: <strong>custom</strong> (modified from ${baseProfile})`;
        }
      }

      function readSelections() {
        const selections = {};
        Object.keys(FEATURES).forEach((feature) => {
          selections[feature] = document.getElementById(feature).checked;
        });
        return selections;
      }

      function computeSize(selections) {
        let size = BASE_SIZE_MB;
        Object.keys(FEATURES).forEach((feature) => {
          if (selections[feature]) size += FEATURES[feature].sizeKb / 1024;
        });
        return size;
      }

      function buildFlags(selections) {
        const flags = [];
        Object.keys(FEATURES).forEach((feature) => {
          const flag = FEATURES[feature].flag;
          flags.push(`-D${flag}=${selections[feature] ? 1 : 0}`);
        });
        return flags.join(" ");
      }

      function buildIni(selections, selectedProfile) {
        const flags = buildFlags(selections).replace(/ -D/g, "\n  -D");
        return `# Custom CrossPoint Reader Build Configuration\n# Generated by web configurator\n# Selected profile: ${selectedProfile}\n\n[env:custom]\nextends = base\nbuild_flags =\n  \\${base.build_flags}\n  -DCROSSPOINT_VERSION=\\\"\\${crosspoint.version}-custom\\\"\n  ${flags}\n`;
      }

      function buildGenerateCommand(selections, matchingProfile, baseProfileName) {
        if (matchingProfile) {
          return `uv run python scripts/generate_build_config.py --profile ${matchingProfile}`;
        }
        const baseSelections = profileToSelections(baseProfileName);
        const args = [
          "uv run python scripts/generate_build_config.py",
          `--profile ${baseProfileName}`,
        ];
        Object.keys(FEATURES).forEach((feature) => {
          if (selections[feature] !== baseSelections[feature]) {
            args.push(selections[feature] ? `--enable ${feature}` : `--disable ${feature}`);
          }
        });
        return args.join(" ");
      }

      function buildShareUrl(selections, selectedProfile) {
        const url = new URL(window.location.href);
        url.search = "";
        const shareProfile = selectedProfile === "custom" ? baseProfile : selectedProfile;
        url.searchParams.set("profile", shareProfile);
        Object.keys(FEATURES).forEach((feature) => {
          url.searchParams.set(feature, selections[feature] ? "1" : "0");
        });
        return url.toString();
      }

      function parseInitialStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const requestedProfile = params.get("profile");
        const initialProfile = PROFILES[requestedProfile] ? requestedProfile : "standard";
        const selections = profileToSelections(initialProfile);
        Object.keys(FEATURES).forEach((feature) => {
          const parsed = parseBooleanParam(params.get(feature));
          if (parsed !== null) selections[feature] = parsed;
        });
        applyDependencyRules(selections, null, null);
        return { initialProfile, selections };
      }

      function updateOutputs(selections, selectedProfile, matchingProfile) {
        document.getElementById("flags-output").value = buildFlags(selections);
        document.getElementById("command-output").value = buildGenerateCommand(selections, matchingProfile, baseProfile);
        document.getElementById("ini-output").value = buildIni(selections, selectedProfile);
        document.getElementById("share-output").value = buildShareUrl(selections, selectedProfile);
      }

      function updateBuildLink(selections, selectedProfile) {
        const repo = getRepoInfo();
        const workflow = "build-custom.yml";
        const params = new URLSearchParams();
        params.set("profile", selectedProfile);
        Object.keys(FEATURES).forEach((feature) => {
          params.set(feature, selections[feature] ? "true" : "false");
        });
        const url = `https://github.com/${repo.owner}/${repo.repo}/actions/workflows/${workflow}?${params.toString()}`;
        document.getElementById("build-link").href = url;
      }

      /* Skill tree visuals */

      function formatSize(sizeKb) {
        if (sizeKb === 0) return '';
        if (Math.abs(sizeKb) >= 1024) return `~${(sizeKb / 1024).toFixed(1)} MB`;
        return `~${sizeKb} KB`;
      }

      function updateSizeDisplay(size) {
        const percentage = (size / MAX_FLASH_MB) * 100;
        const sizeValue = document.getElementById("size-value");
        const sizeBar = document.getElementById("size-bar");
        const sizeContext = document.getElementById("size-context");

        sizeValue.textContent = `${size.toFixed(1)} MB`;
        sizeBar.style.width = `${Math.min(percentage, 100)}%`;

        if (size > MAX_FLASH_MB) {
          sizeContext.textContent = `${percentage.toFixed(0)}% \u2014 over capacity`;
          sizeValue.style.color = "#111";
          sizeBar.classList.add("over");
        } else {
          const remaining = MAX_FLASH_MB - size;
          sizeContext.textContent = `${percentage.toFixed(0)}% of 6.4 MB \u2014 ${remaining.toFixed(1)} MB free`;
          sizeValue.style.color = "var(--ink)";
          sizeBar.classList.remove("over");
        }
      }

      function isFeatureNode(nodeId) {
        return Object.prototype.hasOwnProperty.call(FEATURES, nodeId);
      }

      function isFeatureBlocked(feature, selections) {
        const parents = FEATURE_DEPENDENCIES[feature] || [];
        return parents.some((parent) => !selections[parent]);
      }

      function updateHubVisuals(selections) {
        document.querySelectorAll(".graph-hub[data-node-id]").forEach((hub) => {
          const hubId = hub.dataset.nodeId;
          const hasAnySelected = (HUB_FEATURES[hubId] || []).some((feature) => selections[feature]);
          hub.classList.toggle("active", hasAnySelected);
        });
      }

      function getNodeCenter(containerRect, nodeEl) {
        const centerTarget = nodeEl.querySelector(".node-ring") || nodeEl;
        const rect = centerTarget.getBoundingClientRect();
        return {
          x: rect.left - containerRect.left + rect.width / 2,
          y: rect.top - containerRect.top + rect.height / 2,
        };
      }

      function renderGraphEdges(selections) {
        const tree = document.getElementById("skill-tree");
        const svg = document.getElementById("graph-links");
        if (!tree || !svg) return;

        const width = tree.clientWidth;
        const height = tree.clientHeight;
        if (!width || !height) return;

        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.innerHTML = "";

        const treeRect = tree.getBoundingClientRect();
        const hubStates = {};
        Object.keys(HUB_FEATURES).forEach((hubId) => {
          hubStates[hubId] = HUB_FEATURES[hubId].some((feature) => selections[feature]);
        });

        GRAPH_EDGES.forEach((edge) => {
          const fromEl = tree.querySelector(`[data-node-id="${edge.from}"]`);
          const toEl = tree.querySelector(`[data-node-id="${edge.to}"]`);
          if (!fromEl || !toEl) return;

          const fromPoint = getNodeCenter(treeRect, fromEl);
          const toPoint = getNodeCenter(treeRect, toEl);
          const toIsFeature = isFeatureNode(edge.to);
          const fromIsFeature = isFeatureNode(edge.from);

          let active = false;
          let locked = false;

          if (Object.prototype.hasOwnProperty.call(HUB_FEATURES, edge.to)) {
            active = hubStates[edge.to];
          } else if (toIsFeature) {
            active = selections[edge.to] && (!fromIsFeature || selections[edge.from]);
            locked = isFeatureBlocked(edge.to, selections);
          }

          if (locked) active = false;

          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute("x1", fromPoint.x.toFixed(2));
          line.setAttribute("y1", fromPoint.y.toFixed(2));
          line.setAttribute("x2", toPoint.x.toFixed(2));
          line.setAttribute("y2", toPoint.y.toFixed(2));
          line.classList.add("graph-edge");
          if (active) line.classList.add("active");
          if (locked) line.classList.add("locked");
          svg.appendChild(line);
        });
      }

      function updateSkillTreeVisuals(selections) {
        document.querySelectorAll(".skill-node[data-feature]").forEach((node) => {
          const feature = node.dataset.feature;
          const isEnabled = selections[feature];
          const isBlocked = isFeatureBlocked(feature, selections);
          const checkbox = node.querySelector("input");

          node.classList.toggle("active", isEnabled);
          node.classList.toggle("locked", isBlocked);
          checkbox.disabled = isBlocked;

          const sizeEl = node.querySelector(".tooltip-size");
          if (sizeEl) {
            const featureSize = formatSize(FEATURES[feature].sizeKb);
            sizeEl.textContent = featureSize ? `Flash: ${featureSize}` : "";
          }

          const nodeSizeEl = node.querySelector(".node-size");
          if (nodeSizeEl) {
            nodeSizeEl.textContent = formatSize(FEATURES[feature].sizeKb);
          }

          const iconEl = node.querySelector(".node-icon");
          if (isBlocked && iconEl) {
            iconEl.dataset.origIcon = iconEl.dataset.origIcon || iconEl.innerHTML;
            iconEl.innerHTML = "&#x1F512;";
          } else if (iconEl && iconEl.dataset.origIcon) {
            iconEl.innerHTML = iconEl.dataset.origIcon;
          }
        });

        updateHubVisuals(selections);
        renderGraphEdges(selections);
      }

      function updateDependencyUi(selections) {
        updateSkillTreeVisuals(selections);
      }

      function updateAll(changedFeature = null, enabled = null) {
        const selections = readSelections();
        applyDependencyRules(selections, changedFeature, enabled);
        setSelections(selections);
        updateDependencyUi(selections);
        const matchingProfile = detectMatchingProfile(selections);
        highlightProfile(matchingProfile);
        updateProfileStatus(matchingProfile);
        const selectedProfile = matchingProfile || "custom";
        const size = computeSize(selections);
        updateSizeDisplay(size);
        updateOutputs(selections, selectedProfile, matchingProfile);
        updateBuildLink(selections, selectedProfile);
      }

      function flashCopyButton(btn) {
        btn.classList.add('copied');
        const orig = btn.textContent;
        btn.textContent = 'Copied';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.textContent = orig;
        }, 1200);
      }

      function setupEvents() {
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.addEventListener("click", () => applyProfile(btn.dataset.preset));
        });

        document.querySelectorAll("input[data-feature]").forEach((checkbox) => {
          checkbox.addEventListener("change", (event) => {
            const feature = event.target.dataset.feature;
            updateAll(feature, event.target.checked);
          });
        });

        const copyCommand = document.getElementById("copy-command");
        copyCommand.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("command-output").value);
          flashCopyButton(copyCommand);
        });

        const copyFlags = document.getElementById("copy-flags");
        copyFlags.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("flags-output").value);
          flashCopyButton(copyFlags);
        });

        const copyShare = document.getElementById("copy-share");
        copyShare.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("share-output").value);
          flashCopyButton(copyShare);
        });

        document.getElementById("download-ini").addEventListener("click", () => {
          const content = document.getElementById("ini-output").value;
          const blob = new Blob([content], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "platformio-custom.ini";
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
        });

        let resizeFrame = null;
        window.addEventListener("resize", () => {
          if (resizeFrame !== null) cancelAnimationFrame(resizeFrame);
          resizeFrame = requestAnimationFrame(() => {
            resizeFrame = null;
            renderGraphEdges(readSelections());
          });
        });

        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(() => {
            renderGraphEdges(readSelections());
          });
        }
      }

      async function loadScreenPreviews() {
        const grid = document.getElementById("preview-grid");
        const meta = document.getElementById("preview-meta");
        const manifestUrl = "./screen-previews/manifest.json";

        try {
          const response = await fetch(manifestUrl, { cache: "no-store" });
          if (!response.ok) throw new Error(`manifest fetch failed (${response.status})`);
          const manifest = await response.json();

          const files = Array.isArray(manifest.files) ? manifest.files : [];
          if (files.length === 0) throw new Error("manifest is empty");

          const cards = files
            .map((file) => {
              const label = file.label || file.name || "Preview";
              const src = `./screen-previews/${file.name}`;
              return `<figure class="preview-card"><img src="${src}" alt="${label}" loading="lazy" /><figcaption>${label}</figcaption></figure>`;
            })
            .join("");

          grid.innerHTML = cards;
          const generatedAt = manifest.generated_at
            ? `Updated ${new Date(manifest.generated_at).toLocaleString()}`
            : "Updated recently";
          meta.textContent = generatedAt;
        } catch (error) {
          grid.innerHTML = '<div class="note-bar">Preview images are publishing. Check back in a minute.</div>';
          meta.textContent = "";
        }
      }

      setupEvents();
      const initialState = parseInitialStateFromUrl();
      baseProfile = initialState.initialProfile;
      setSelections(initialState.selections);
      highlightProfile(baseProfile);
      updateAll();
      loadScreenPreviews();
    </script>
  </body>
</html>
