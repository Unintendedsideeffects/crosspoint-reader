<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrossPoint Reader - Skill Tree</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&family=IBM+Plex+Mono:wght@400;500&family=Source+Sans+3:wght@400;500;600&display=swap");

      :root {
        --ink: #d9ccab;
        --ink-mid: #b8ab8a;
        --ink-light: #95886b;
        --ink-faint: #736850;
        --paper: #171b23;
        --paper-warm: #1e2530;
        --paper-bright: #232b38;
        --active-fill: #5ca8da;
        --active-stroke: #8ad5ff;
        --locked-fill: #171d26;
        --locked-stroke: #4f5866;
        --locked-text: #6e7888;
        --bar-fill: linear-gradient(90deg, #78bde8 0%, #b3e4ff 100%);
        --bar-track: #2b3341;
        --border: #434c5d;
        --border-light: #303847;
        --radius: 12px;
        --shadow: 0 18px 42px rgba(0, 0, 0, 0.42);
        --constellation-glow: 0 0 18px rgba(130, 203, 255, 0.45);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Source Sans 3', sans-serif;
        background:
          radial-gradient(130% 90% at 50% 8%, #2a3446 0%, #161b24 46%, #0f131a 100%),
          linear-gradient(180deg, #1b212c 0%, #0f141b 100%);
        color: var(--ink);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
      }

      .page {
        max-width: 1180px;
        margin: 0 auto;
        padding: 40px 20px 80px;
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 36px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-light);
      }

      .header-eyebrow {
        font-family: 'IBM Plex Mono', monospace;
        letter-spacing: 0.34em;
        text-transform: uppercase;
        font-size: 0.64rem;
        color: var(--ink-light);
        margin-bottom: 8px;
      }

      .header h1 {
        font-family: 'Cinzel', serif;
        font-weight: 700;
        font-size: clamp(2.1rem, 4.2vw, 3.2rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--ink);
        text-shadow: 0 0 22px rgba(113, 188, 232, 0.18);
      }

      .header-sub {
        color: var(--ink-mid);
        font-size: 0.95rem;
        margin-top: 10px;
        font-weight: 400;
      }

      /* Flash meter */
      .flash-meter {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 18px;
        background: var(--paper-bright);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 20px;
        flex-wrap: wrap;
        box-shadow: var(--shadow);
      }

      .flash-label {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.65rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--ink-light);
      }

      .flash-value {
        font-family: 'Cinzel', serif;
        font-size: 1.55rem;
        font-weight: 700;
        color: var(--ink);
        min-width: 70px;
        letter-spacing: 0.04em;
      }

      .flash-track {
        flex: 1;
        min-width: 180px;
        height: 8px;
        background: var(--bar-track);
        border-radius: 99px;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      }

      .flash-fill {
        height: 100%;
        background: var(--bar-fill);
        border-radius: 99px;
        transition: width 0.35s ease;
      }

      .flash-fill.over {
        background: #c00;
      }

      .flash-context {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.72rem;
        color: var(--ink-light);
      }

      /* Loadout / profiles */
      .loadout-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
        flex-wrap: wrap;
      }

      .loadout-label {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.65rem;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--ink-mid);
        margin-right: 4px;
      }

      .preset-btn {
        background: var(--paper-bright);
        border: 1px solid var(--border);
        color: var(--ink);
        padding: 6px 15px;
        border-radius: 6px;
        font-family: 'Cinzel', serif;
        font-size: 0.82rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.18s ease;
      }

      .preset-btn:hover {
        border-color: var(--active-stroke);
        box-shadow: 0 0 12px rgba(98, 164, 208, 0.28);
      }

      .preset-btn.active {
        background: linear-gradient(180deg, #4f84ab 0%, #3b6786 100%);
        color: #e8f4ff;
        border-color: #82bce8;
      }

      .profile-status {
        font-size: 0.78rem;
        color: var(--ink-light);
        margin-bottom: 28px;
      }

      .profile-status strong {
        color: var(--ink);
        font-weight: 600;
      }

      /* Skill Tree Grid */
      .skill-tree {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0 12px;
        margin-bottom: 36px;
        padding: 26px 18px 16px;
        background:
          radial-gradient(120% 120% at 50% 0%, rgba(123, 169, 206, 0.16) 0%, rgba(22, 28, 37, 0) 58%),
          linear-gradient(180deg, #1b222e 0%, #121821 100%);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .skill-tree::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.28;
        background-image:
          radial-gradient(circle at 14% 22%, #d8e9ff 0, #d8e9ff 1px, transparent 2px),
          radial-gradient(circle at 69% 17%, #b8dbf6 0, #b8dbf6 1px, transparent 2px),
          radial-gradient(circle at 41% 64%, #d1e8ff 0, #d1e8ff 1px, transparent 2px),
          radial-gradient(circle at 86% 53%, #d1e8ff 0, #d1e8ff 1px, transparent 2px);
      }

      .skill-tree::after {
        content: "";
        position: absolute;
        inset: 6px;
        border: 1px solid rgba(130, 188, 232, 0.14);
        border-radius: 12px;
        pointer-events: none;
      }

      .skill-branch {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
      }

      .branch-header {
        font-family: 'Cinzel', serif;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.22em;
        text-transform: uppercase;
        color: #d8e5f4;
        margin-bottom: 18px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(132, 163, 193, 0.35);
        width: 100%;
        text-align: center;
        text-shadow: 0 0 10px rgba(138, 188, 223, 0.25);
      }

      /* Skill Node */
      .skill-node {
        position: relative;
        width: 100%;
        max-width: 140px;
        margin-bottom: 10px;
        cursor: pointer;
        -webkit-user-select: none;
        user-select: none;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .skill-node input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
      }

      .node-ring {
        width: 58px;
        height: 58px;
        border-radius: 50%;
        border: 1px solid rgba(172, 196, 224, 0.52);
        background: radial-gradient(circle at 35% 25%, #344154 0%, #202936 52%, #141b25 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.24s ease;
        position: relative;
        margin-bottom: 6px;
        box-shadow:
          inset 0 0 0 1px rgba(218, 235, 255, 0.08),
          0 6px 12px rgba(0, 0, 0, 0.35);
      }

      .node-ring::after {
        content: "";
        position: absolute;
        inset: 6px;
        border-radius: 50%;
        border: 1px solid rgba(209, 226, 248, 0.25);
      }

      .node-icon {
        font-size: 1.05rem;
        line-height: 1;
        color: #d5dfed;
        text-shadow: 0 0 8px rgba(150, 190, 230, 0.35);
        transition: all 0.25s ease;
        z-index: 1;
      }

      .skill-node.active .node-ring {
        background: radial-gradient(circle at 32% 22%, #4a6d8d 0%, #2d4459 48%, #192734 100%);
        border-color: var(--active-stroke);
        box-shadow:
          inset 0 0 0 1px rgba(195, 232, 255, 0.24),
          var(--constellation-glow);
      }

      .skill-node.active .node-icon {
        color: #f2fbff;
        filter: none;
      }

      .skill-node.locked .node-ring {
        background: radial-gradient(circle at 35% 25%, #2a3340 0%, #171e28 100%);
        border-color: var(--locked-stroke);
        border-style: dashed;
        box-shadow: inset 0 0 0 1px rgba(120, 130, 146, 0.12);
      }

      .skill-node.locked .node-icon {
        color: var(--locked-text);
        font-size: 0.82rem;
        text-shadow: none;
      }

      .node-label {
        text-align: center;
        font-size: 0.73rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #aeb9ca;
        line-height: 1.2;
        transition: color 0.2s ease;
      }

      .skill-node.active .node-label {
        color: #e4f3ff;
        font-weight: 600;
        text-shadow: 0 0 10px rgba(137, 201, 245, 0.25);
      }

      .skill-node.locked .node-label {
        color: var(--locked-text);
      }

      .node-size {
        text-align: center;
        font-size: 0.62rem;
        font-family: 'IBM Plex Mono', monospace;
        color: #7f8a9d;
        margin-top: 1px;
      }

      .skill-node.active .node-size {
        color: #a9d5f2;
      }

      /* Connector */
      .connector {
        width: 1px;
        height: 16px;
        margin: -2px auto 2px;
        position: relative;
      }

      .connector-line {
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, rgba(166, 182, 206, 0.2) 0%, rgba(120, 132, 152, 0.42) 100%);
        transition: background 0.25s ease;
      }

      .connector.active .connector-line {
        background: linear-gradient(180deg, #7cc0ea 0%, #b6e6ff 100%);
        box-shadow: 0 0 10px rgba(130, 206, 255, 0.38);
      }

      .connector.locked .connector-line {
        background: var(--locked-stroke);
        /* dashed via repeating gradient */
        background: repeating-linear-gradient(
          to bottom,
          var(--locked-stroke) 0px,
          var(--locked-stroke) 3px,
          transparent 3px,
          transparent 6px
        );
      }

      /* Fork connector */
      .fork-container {
        display: flex;
        width: 100%;
      }

      .fork-branch {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
      }

      .fork-top {
        width: 100%;
        height: 14px;
        position: relative;
        margin-bottom: 0;
      }

      .fork-top-line {
        position: absolute;
        top: 0;
        height: 100%;
        border-color: rgba(134, 150, 173, 0.42);
        border-style: solid;
        transition: all 0.25s ease;
      }

      .fork-top-line.left {
        right: 0;
        left: 50%;
        border-width: 0 0 1px 1px;
        border-bottom-left-radius: 6px;
      }

      .fork-top-line.right {
        left: 0;
        right: 50%;
        border-width: 0 1px 1px 0;
        border-bottom-right-radius: 6px;
      }

      .fork-top.active .fork-top-line {
        border-color: #9bd3fb;
        box-shadow: 0 0 8px rgba(131, 204, 252, 0.3);
      }

      .fork-top.locked .fork-top-line {
        border-color: var(--locked-stroke);
        border-style: dashed;
      }

      /* Spacer between unconnected nodes */
      .node-gap {
        height: 12px;
      }

      /* Tooltip */
      .skill-node .tooltip {
        position: absolute;
        bottom: calc(100% + 6px);
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(180deg, #232d39 0%, #1a222d 100%);
        border: 1px solid #4b596f;
        border-radius: 8px;
        padding: 11px 12px;
        min-width: 190px;
        max-width: 240px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.12s ease;
        z-index: 100;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
      }

      .skill-node:hover .tooltip {
        opacity: 1;
      }

      .tooltip-title {
        font-family: 'Cinzel', serif;
        font-weight: 700;
        font-size: 0.8rem;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        color: #e4f3ff;
        margin-bottom: 3px;
      }

      .tooltip-desc {
        font-size: 0.75rem;
        color: #c2cbda;
        line-height: 1.4;
        margin-bottom: 4px;
      }

      .tooltip-size {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.68rem;
        color: #8fc7ed;
      }

      .tooltip-req {
        font-size: 0.68rem;
        color: #9ab0c8;
        margin-top: 3px;
        font-style: italic;
      }

      .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: #4b596f;
      }

      /* Panels */
      .panel {
        background: var(--paper-bright);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px 19px;
        margin-bottom: 14px;
        box-shadow: var(--shadow);
      }

      .panel-heading {
        font-family: 'Cinzel', serif;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: #c8d9ed;
        margin-bottom: 12px;
      }

      .outputs-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .output { margin-bottom: 0; }

      .output-label {
        font-size: 0.72rem;
        font-weight: 500;
        color: #9eabc0;
        margin-bottom: 4px;
      }

      .output textarea {
        width: 100%;
        min-height: 72px;
        background: #1a222d;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        padding: 8px 10px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.72rem;
        color: #c9d8ea;
        resize: vertical;
      }

      .output textarea:focus {
        outline: none;
        border-color: #7bb6e3;
        box-shadow: 0 0 0 2px rgba(116, 185, 232, 0.16);
      }

      .actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .btn {
        border: none;
        border-radius: 6px;
        padding: 7px 13px;
        font-family: 'Source Sans 3', sans-serif;
        font-size: 0.78rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.18s ease;
        text-decoration: none;
        text-align: center;
      }

      .btn-outline {
        background: #1d2530;
        color: #c3d1e1;
        border: 1px solid var(--border);
      }

      .btn-outline:hover {
        border-color: #8ac5ee;
        color: #edf8ff;
        box-shadow: 0 0 14px rgba(116, 185, 232, 0.24);
      }

      .btn-outline.copied {
        background: #4a7ea5;
        color: #f2fbff;
        border-color: #8ac5ee;
      }

      .btn-solid {
        background: linear-gradient(180deg, #4f84ab 0%, #3a6382 100%);
        color: #f1f9ff;
        border: 1px solid #8abbe2;
      }

      .btn-solid:hover {
        filter: brightness(1.06);
      }

      .info-bar {
        margin-top: 10px;
        padding: 8px 12px;
        border-left: 2px solid #7fb7df;
        font-size: 0.78rem;
        color: #a3b2c7;
        font-style: italic;
        background: rgba(23, 29, 38, 0.62);
        border-radius: 0 6px 6px 0;
      }

      /* Companion */
      .companion-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        flex-wrap: wrap;
      }

      .companion-title {
        font-weight: 600;
        font-size: 0.88rem;
      }

      .companion-desc {
        font-size: 0.78rem;
        color: #a8b6c9;
        margin-top: 3px;
      }

      .companion-desc code {
        background: #1a222d;
        padding: 1px 4px;
        border-radius: 2px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.7rem;
      }

      /* Preview */
      .preview-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .preview-sub {
        font-size: 0.78rem;
        color: #9fb0c4;
        margin-top: 3px;
      }

      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 10px;
      }

      .preview-card {
        border: 1px solid var(--border-light);
        border-radius: 8px;
        overflow: hidden;
        background: #1b232d;
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.32);
      }

      .preview-card img {
        width: 100%;
        height: auto;
        display: block;
      }

      .preview-card figcaption {
        padding: 6px 8px;
        font-size: 0.72rem;
        color: #a6b6ca;
      }

      .preview-meta {
        margin-top: 8px;
        font-size: 0.7rem;
        color: #7d8aa0;
      }

      .footer {
        text-align: center;
        margin-top: 24px;
        font-size: 0.75rem;
        color: #6d7a90;
      }

      /* Responsive */
      @media (max-width: 800px) {
        .skill-tree {
          grid-template-columns: repeat(2, 1fr);
          gap: 18px 12px;
        }
        .outputs-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 480px) {
        .skill-tree {
          grid-template-columns: 1fr 1fr;
          gap: 16px 8px;
        }
        .flash-meter {
          flex-direction: column;
          align-items: stretch;
        }
      }

      /* Hover ring effect */
      .skill-node:not(.locked):hover .node-ring {
        border-color: #a4d5f8;
        box-shadow:
          inset 0 0 0 1px rgba(205, 236, 255, 0.26),
          0 0 14px rgba(133, 198, 240, 0.26);
      }

      .skill-node.active:hover .node-ring {
        box-shadow:
          inset 0 0 0 1px rgba(230, 247, 255, 0.3),
          0 0 22px rgba(120, 198, 243, 0.45);
      }

      /* Note style */
      .note-bar {
        padding: 8px 12px;
        border-left: 2px solid #7fb7df;
        font-size: 0.78rem;
        color: #9fb0c4;
        margin-top: 10px;
        font-style: italic;
        background: rgba(20, 25, 34, 0.74);
        border-radius: 0 6px 6px 0;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <div class="header-eyebrow">CrossPoint Reader</div>
        <h1>Skill Constellation</h1>
        <div class="header-sub">
          Shape your firmware graph like a Nordic perk map within the 6.4 MB flash limit.
        </div>
      </div>

      <!-- Flash meter -->
      <div class="flash-meter">
        <span class="flash-label">Flash</span>
        <span class="flash-value" id="size-value">6.0 MB</span>
        <div class="flash-track">
          <div class="flash-fill" id="size-bar" style="width: 0%"></div>
        </div>
        <span class="flash-context" id="size-context">94% of 6.4 MB</span>
      </div>

      <!-- Loadout -->
      <div class="loadout-bar">
        <span class="loadout-label">Loadout</span>
        <button class="preset-btn" data-preset="lean">Lean</button>
        <button class="preset-btn active" data-preset="standard">Standard</button>
        <button class="preset-btn" data-preset="full">Full</button>
      </div>
      <div class="profile-status" id="profile-status"></div>

      <!-- Skill Tree -->
      <div class="skill-tree">
        <!-- READING -->
        <div class="skill-branch">
          <div class="branch-header">Reading</div>

          <label class="skill-node" data-feature="epub_support">
            <input type="checkbox" id="epub_support" data-feature="epub_support" />
            <div class="tooltip">
              <div class="tooltip-title">EPUB Support</div>
              <div class="tooltip-desc">EPUB e-book reader with CSS, images, and chapter navigation</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x1F4D6;</span></div>
            <div class="node-label">EPUB</div>
            <div class="node-size"></div>
          </label>

          <div class="connector" data-conn="epub_support-hyphenation"><div class="connector-line"></div></div>

          <label class="skill-node" data-feature="hyphenation">
            <input type="checkbox" id="hyphenation" data-feature="hyphenation" />
            <div class="tooltip">
              <div class="tooltip-title">Hyphenation</div>
              <div class="tooltip-desc">Language-aware hyphenation for justified EPUB text</div>
              <div class="tooltip-size"></div>
              <div class="tooltip-req">Requires EPUB Support</div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x2E17;</span></div>
            <div class="node-label">Hyphenation</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="markdown">
            <input type="checkbox" id="markdown" data-feature="markdown" />
            <div class="tooltip">
              <div class="tooltip-title">Markdown &amp; Obsidian</div>
              <div class="tooltip-desc">Markdown and Obsidian vault reading support</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x270D;</span></div>
            <div class="node-label">Markdown</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="xtc_support">
            <input type="checkbox" id="xtc_support" data-feature="xtc_support" />
            <div class="tooltip">
              <div class="tooltip-title">XTC Support</div>
              <div class="tooltip-desc">XTC format reader with chapter navigation</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x1F4DC;</span></div>
            <div class="node-label">XTC</div>
            <div class="node-size"></div>
          </label>
        </div>

        <!-- INTERFACE -->
        <div class="skill-branch">
          <div class="branch-header">Interface</div>

          <label class="skill-node" data-feature="extended_fonts">
            <input type="checkbox" id="extended_fonts" data-feature="extended_fonts" />
            <div class="tooltip">
              <div class="tooltip-title">Extended Fonts</div>
              <div class="tooltip-desc">12/16/18pt fonts and OpenDyslexic support</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x1D5D4;</span></div>
            <div class="node-label">Fonts</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="lyra_theme">
            <input type="checkbox" id="lyra_theme" data-feature="lyra_theme" />
            <div class="tooltip">
              <div class="tooltip-title">Lyra Theme</div>
              <div class="tooltip-desc">Alternative UI theme with refined spacing and layout</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x2726;</span></div>
            <div class="node-label">Lyra Theme</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="home_media_picker">
            <input type="checkbox" id="home_media_picker" data-feature="home_media_picker" />
            <div class="tooltip">
              <div class="tooltip-title">Home Media Picker</div>
              <div class="tooltip-desc">Streamlined home UI with horizontal book shelf + vertical menu</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x1F3E0;</span></div>
            <div class="node-label">Home UI</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="image_sleep">
            <input type="checkbox" id="image_sleep" data-feature="image_sleep" />
            <div class="tooltip">
              <div class="tooltip-title">PNG/JPEG Sleep Images</div>
              <div class="tooltip-desc">PNG and JPEG sleep screen support (BMP always included)</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x263D;</span></div>
            <div class="node-label">Sleep Art</div>
            <div class="node-size"></div>
          </label>
        </div>

        <!-- NETWORK -->
        <div class="skill-branch">
          <div class="branch-header">Network</div>

          <label class="skill-node" data-feature="background_server">
            <input type="checkbox" id="background_server" data-feature="background_server" />
            <div class="tooltip">
              <div class="tooltip-title">Background Web Server</div>
              <div class="tooltip-desc">Background web server for file management</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x1F310;</span></div>
            <div class="node-label">Web Server</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="ota_updates">
            <input type="checkbox" id="ota_updates" data-feature="ota_updates" />
            <div class="tooltip">
              <div class="tooltip-title">OTA Updates</div>
              <div class="tooltip-desc">Over-the-air firmware updates via WiFi</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x2B06;</span></div>
            <div class="node-label">OTA</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="integrations">
            <input type="checkbox" id="integrations" data-feature="integrations" />
            <div class="tooltip">
              <div class="tooltip-title">Integrations Base</div>
              <div class="tooltip-desc">Shared runtime hooks for remote sync integrations</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x1F517;</span></div>
            <div class="node-label">Integrations</div>
            <div class="node-size"></div>
          </label>

          <div class="fork-container">
            <div class="fork-branch">
              <div class="fork-top" data-conn="integrations-koreader_sync">
                <div class="fork-top-line left"></div>
              </div>
              <label class="skill-node" data-feature="koreader_sync">
                <input type="checkbox" id="koreader_sync" data-feature="koreader_sync" />
                <div class="tooltip">
                  <div class="tooltip-title">KOReader Sync</div>
                  <div class="tooltip-desc">Sync reading progress with KOReader</div>
                  <div class="tooltip-size"></div>
                  <div class="tooltip-req">Requires Integrations</div>
                </div>
                <div class="node-ring"><span class="node-icon">&#x1F4F1;</span></div>
                <div class="node-label">KOReader</div>
                <div class="node-size"></div>
              </label>
            </div>
            <div class="fork-branch">
              <div class="fork-top" data-conn="integrations-calibre_sync">
                <div class="fork-top-line right"></div>
              </div>
              <label class="skill-node" data-feature="calibre_sync">
                <input type="checkbox" id="calibre_sync" data-feature="calibre_sync" />
                <div class="tooltip">
                  <div class="tooltip-title">Calibre Sync</div>
                  <div class="tooltip-desc">Calibre OPDS browser and metadata sync settings</div>
                  <div class="tooltip-size"></div>
                  <div class="tooltip-req">Requires Integrations</div>
                </div>
                <div class="node-ring"><span class="node-icon">&#x1F4DA;</span></div>
                <div class="node-label">Calibre</div>
                <div class="node-size"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- EXTRAS -->
        <div class="skill-branch">
          <div class="branch-header">Extras</div>

          <label class="skill-node" data-feature="web_pokedex_plugin">
            <input type="checkbox" id="web_pokedex_plugin" data-feature="web_pokedex_plugin" />
            <div class="tooltip">
              <div class="tooltip-title">Web Pokedex Plugin</div>
              <div class="tooltip-desc">Browser-side Pokemon wallpaper generator at /plugins/pokedex</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x26A1;</span></div>
            <div class="node-label">Pokedex</div>
            <div class="node-size"></div>
          </label>

          <div class="node-gap"></div>

          <label class="skill-node" data-feature="todo_planner">
            <input type="checkbox" id="todo_planner" data-feature="todo_planner" />
            <div class="tooltip">
              <div class="tooltip-title">Todo Planner</div>
              <div class="tooltip-desc">Daily markdown notes and task tracking</div>
              <div class="tooltip-size"></div>
            </div>
            <div class="node-ring"><span class="node-icon">&#x2611;</span></div>
            <div class="node-label">Todo</div>
            <div class="node-size"></div>
          </label>
        </div>
      </div>

      <!-- Build Outputs -->
      <div class="panel">
        <div class="panel-heading">Build Output</div>
        <div class="outputs-grid">
          <div class="output">
            <div class="output-label">Build flags</div>
            <textarea id="flags-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">Generate command</div>
            <textarea id="command-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">platformio-custom.ini</div>
            <textarea id="ini-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">Share URL</div>
            <textarea id="share-output" readonly></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-outline" id="copy-command">Copy command</button>
          <button class="btn btn-outline" id="copy-flags">Copy flags</button>
          <button class="btn btn-outline" id="copy-share">Copy URL</button>
          <button class="btn btn-outline" id="download-ini">Download .ini</button>
          <a class="btn btn-solid" id="build-link" href="#" target="_blank" rel="noopener">Build on GitHub Actions</a>
        </div>
        <div class="info-bar">
          Dependencies are enforced automatically. Enabling a child skill unlocks its parent.
        </div>
      </div>

      <!-- Companion -->
      <div class="panel">
        <div class="panel-heading">Companion Plugins</div>
        <div class="companion-row">
          <div>
            <div class="companion-title">X4 Grayscale Pokedex Wallpaper</div>
            <div class="companion-desc">
              Generate wallpapers from Pokemon data. Upload to
              <code>/sleep/pokedex</code> for Sleep Source mode.
            </div>
          </div>
          <a class="btn btn-outline" href="../plugins/x4-pokedex-grayscale/" target="_blank" rel="noopener">Open Plugin</a>
        </div>
      </div>

      <!-- Preview -->
      <div class="panel">
        <div class="preview-top">
          <div>
            <div class="panel-heading" style="margin-bottom: 0">Live Screen Previews</div>
            <div class="preview-sub">Auto-generated from the latest firmware UI harness.</div>
          </div>
          <a class="btn btn-outline" href="./screen-previews/" target="_blank" rel="noopener">Open Folder</a>
        </div>
        <div class="preview-grid" id="preview-grid"></div>
        <div class="preview-meta" id="preview-meta"></div>
      </div>

      <div class="footer">Future roadmap: this picker will live inside the OTA update menu.</div>
    </div>

    <script>
      const FEATURES = {
        extended_fonts: {
          sizeKb: 3630,
          flag: "ENABLE_EXTENDED_FONTS",
          default: true,
        },
        image_sleep: {
          sizeKb: 0,
          flag: "ENABLE_IMAGE_SLEEP",
          default: true,
        },
        markdown: {
          sizeKb: 231,
          flag: "ENABLE_MARKDOWN",
          default: true,
        },
        integrations: {
          sizeKb: 0,
          flag: "ENABLE_INTEGRATIONS",
          default: false,
        },
        koreader_sync: {
          sizeKb: 142,
          flag: "ENABLE_KOREADER_SYNC",
          default: false,
        },
        calibre_sync: {
          sizeKb: 223,
          flag: "ENABLE_CALIBRE_SYNC",
          default: false,
        },
        background_server: {
          sizeKb: 0,
          flag: "ENABLE_BACKGROUND_SERVER",
          default: true,
        },
        home_media_picker: {
          sizeKb: -4,
          flag: "ENABLE_HOME_MEDIA_PICKER",
          default: true,
        },
        web_pokedex_plugin: {
          sizeKb: 4,
          flag: "ENABLE_WEB_POKEDEX_PLUGIN",
          default: false,
        },
        epub_support: {
          sizeKb: 157,
          flag: "ENABLE_EPUB_SUPPORT",
          default: true,
        },
        hyphenation: {
          sizeKb: 447,
          flag: "ENABLE_HYPHENATION",
          default: true,
        },
        xtc_support: {
          sizeKb: 13,
          flag: "ENABLE_XTC_SUPPORT",
          default: true,
        },
        lyra_theme: {
          sizeKb: 5,
          flag: "ENABLE_LYRA_THEME",
          default: true,
        },
        ota_updates: {
          sizeKb: 230,
          flag: "ENABLE_OTA_UPDATES",
          default: true,
        },
        todo_planner: {
          sizeKb: 6,
          flag: "ENABLE_TODO_PLANNER",
          default: false,
        },
      };

      const BASE_SIZE_MB = 1.66;
      const MAX_FLASH_MB = 6.4;
      const FEATURE_DEPENDENCIES = {
        koreader_sync: ["integrations"],
        calibre_sync: ["integrations"],
        hyphenation: ["epub_support"],
      };

      const PROFILES = {
        lean: {},
        standard: {
          extended_fonts: true,
          image_sleep: true,
          epub_support: true,
          hyphenation: true,
          xtc_support: true,
          lyra_theme: true,
          ota_updates: true,
          background_server: true,
          home_media_picker: true,
        },
        full: {
          extended_fonts: true,
          image_sleep: true,
          markdown: true,
          integrations: true,
          koreader_sync: true,
          calibre_sync: true,
          epub_support: true,
          hyphenation: true,
          xtc_support: true,
          lyra_theme: true,
          ota_updates: true,
          todo_planner: true,
          background_server: true,
          home_media_picker: true,
          web_pokedex_plugin: true,
        },
      };

      let baseProfile = "standard";

      function getRepoInfo() {
        const host = window.location.hostname;
        const pathParts = window.location.pathname.split("/").filter(Boolean);
        if (host.endsWith("github.io") && pathParts.length > 0) {
          return { owner: host.split(".")[0], repo: pathParts[0] };
        }
        return { owner: "Unintendedsideeffects", repo: "crosspoint-reader" };
      }

      function parseBooleanParam(value) {
        if (value == null) return null;
        const normalized = value.toLowerCase();
        if (normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on") return true;
        if (normalized === "0" || normalized === "false" || normalized === "no" || normalized === "off") return false;
        return null;
      }

      function profileToSelections(name) {
        const profile = PROFILES[name] || {};
        const selections = {};
        Object.keys(FEATURES).forEach((feature) => {
          selections[feature] = Boolean(profile[feature]);
        });
        return selections;
      }

      function setSelections(selections) {
        Object.keys(FEATURES).forEach((feature) => {
          const checkbox = document.getElementById(feature);
          checkbox.checked = Boolean(selections[feature]);
        });
      }

      function enableDependencies(feature, selections) {
        const parents = FEATURE_DEPENDENCIES[feature] || [];
        parents.forEach((parent) => {
          if (!selections[parent]) {
            selections[parent] = true;
            enableDependencies(parent, selections);
          }
        });
      }

      function disableDependents(feature, selections) {
        Object.keys(FEATURE_DEPENDENCIES).forEach((child) => {
          const parents = FEATURE_DEPENDENCIES[child] || [];
          if (parents.includes(feature) && selections[child]) {
            selections[child] = false;
            disableDependents(child, selections);
          }
        });
      }

      function applyDependencyRules(selections, changedFeature, enabled) {
        if (changedFeature) {
          if (enabled) {
            enableDependencies(changedFeature, selections);
          } else {
            disableDependents(changedFeature, selections);
          }
        }
        Object.keys(FEATURE_DEPENDENCIES).forEach((child) => {
          const parents = FEATURE_DEPENDENCIES[child] || [];
          const missingParent = parents.some((parent) => !selections[parent]);
          if (missingParent) selections[child] = false;
        });
      }

      function highlightProfile(profileName) {
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.preset === profileName);
        });
      }

      function detectMatchingProfile(selections) {
        for (const [profileName] of Object.entries(PROFILES)) {
          const profileSelections = profileToSelections(profileName);
          const isMatch = Object.keys(FEATURES).every(
            (feature) => selections[feature] === profileSelections[feature]
          );
          if (isMatch) return profileName;
        }
        return null;
      }

      function applyProfile(name) {
        if (!PROFILES[name]) return;
        baseProfile = name;
        setSelections(profileToSelections(name));
        highlightProfile(name);
        updateAll();
      }

      function updateProfileStatus(matchingProfile) {
        const status = document.getElementById("profile-status");
        if (matchingProfile) {
          status.innerHTML = `Active loadout: <strong>${matchingProfile}</strong>`;
        } else {
          status.innerHTML = `Active loadout: <strong>custom</strong> (modified from ${baseProfile})`;
        }
      }

      function readSelections() {
        const selections = {};
        Object.keys(FEATURES).forEach((feature) => {
          selections[feature] = document.getElementById(feature).checked;
        });
        return selections;
      }

      function computeSize(selections) {
        let size = BASE_SIZE_MB;
        Object.keys(FEATURES).forEach((feature) => {
          if (selections[feature]) size += FEATURES[feature].sizeKb / 1024;
        });
        return size;
      }

      function buildFlags(selections) {
        const flags = [];
        Object.keys(FEATURES).forEach((feature) => {
          const flag = FEATURES[feature].flag;
          flags.push(`-D${flag}=${selections[feature] ? 1 : 0}`);
        });
        return flags.join(" ");
      }

      function buildIni(selections, selectedProfile) {
        const flags = buildFlags(selections).replace(/ -D/g, "\n  -D");
        return `# Custom CrossPoint Reader Build Configuration\n# Generated by web configurator\n# Selected profile: ${selectedProfile}\n\n[env:custom]\nextends = base\nbuild_flags =\n  \\${base.build_flags}\n  -DCROSSPOINT_VERSION=\\\"\\${crosspoint.version}-custom\\\"\n  ${flags}\n`;
      }

      function buildGenerateCommand(selections, matchingProfile, baseProfileName) {
        if (matchingProfile) {
          return `uv run python scripts/generate_build_config.py --profile ${matchingProfile}`;
        }
        const baseSelections = profileToSelections(baseProfileName);
        const args = [
          "uv run python scripts/generate_build_config.py",
          `--profile ${baseProfileName}`,
        ];
        Object.keys(FEATURES).forEach((feature) => {
          if (selections[feature] !== baseSelections[feature]) {
            args.push(selections[feature] ? `--enable ${feature}` : `--disable ${feature}`);
          }
        });
        return args.join(" ");
      }

      function buildShareUrl(selections, selectedProfile) {
        const url = new URL(window.location.href);
        url.search = "";
        const shareProfile = selectedProfile === "custom" ? baseProfile : selectedProfile;
        url.searchParams.set("profile", shareProfile);
        Object.keys(FEATURES).forEach((feature) => {
          url.searchParams.set(feature, selections[feature] ? "1" : "0");
        });
        return url.toString();
      }

      function parseInitialStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const requestedProfile = params.get("profile");
        const initialProfile = PROFILES[requestedProfile] ? requestedProfile : "standard";
        const selections = profileToSelections(initialProfile);
        Object.keys(FEATURES).forEach((feature) => {
          const parsed = parseBooleanParam(params.get(feature));
          if (parsed !== null) selections[feature] = parsed;
        });
        applyDependencyRules(selections, null, null);
        return { initialProfile, selections };
      }

      function updateOutputs(selections, selectedProfile, matchingProfile) {
        document.getElementById("flags-output").value = buildFlags(selections);
        document.getElementById("command-output").value = buildGenerateCommand(selections, matchingProfile, baseProfile);
        document.getElementById("ini-output").value = buildIni(selections, selectedProfile);
        document.getElementById("share-output").value = buildShareUrl(selections, selectedProfile);
      }

      function updateBuildLink(selections, selectedProfile) {
        const repo = getRepoInfo();
        const workflow = "build-custom.yml";
        const params = new URLSearchParams();
        params.set("profile", selectedProfile);
        Object.keys(FEATURES).forEach((feature) => {
          params.set(feature, selections[feature] ? "true" : "false");
        });
        const url = `https://github.com/${repo.owner}/${repo.repo}/actions/workflows/${workflow}?${params.toString()}`;
        document.getElementById("build-link").href = url;
      }

      /* Skill tree visuals */

      function formatSize(sizeKb) {
        if (sizeKb === 0) return '';
        if (Math.abs(sizeKb) >= 1024) return `~${(sizeKb / 1024).toFixed(1)} MB`;
        return `~${sizeKb} KB`;
      }

      function updateSizeDisplay(size) {
        const percentage = (size / MAX_FLASH_MB) * 100;
        const sizeValue = document.getElementById("size-value");
        const sizeBar = document.getElementById("size-bar");
        const sizeContext = document.getElementById("size-context");

        sizeValue.textContent = `${size.toFixed(1)} MB`;
        sizeBar.style.width = `${Math.min(percentage, 100)}%`;

        if (size > MAX_FLASH_MB) {
          sizeContext.textContent = `${percentage.toFixed(0)}% \u2014 over capacity`;
          sizeValue.style.color = "#c00";
          sizeBar.classList.add("over");
        } else {
          const remaining = MAX_FLASH_MB - size;
          sizeContext.textContent = `${percentage.toFixed(0)}% of 6.4 MB \u2014 ${remaining.toFixed(1)} MB free`;
          sizeValue.style.color = "var(--ink)";
          sizeBar.classList.remove("over");
        }
      }

      function updateSkillTreeVisuals(selections) {
        document.querySelectorAll('.skill-node[data-feature]').forEach(node => {
          const feature = node.dataset.feature;
          const isEnabled = selections[feature];
          const parents = FEATURE_DEPENDENCIES[feature] || [];
          const isBlocked = parents.some(p => !selections[p]);
          const checkbox = node.querySelector('input');

          node.classList.toggle('active', isEnabled);
          node.classList.toggle('locked', isBlocked);
          checkbox.disabled = isBlocked;

          const sizeEl = node.querySelector('.tooltip-size');
          if (sizeEl) {
            const s = formatSize(FEATURES[feature].sizeKb);
            sizeEl.textContent = s ? `Flash: ${s}` : '';
          }

          const nodeSizeEl = node.querySelector('.node-size');
          if (nodeSizeEl) {
            nodeSizeEl.textContent = formatSize(FEATURES[feature].sizeKb);
          }

          const iconEl = node.querySelector('.node-icon');
          if (isBlocked && iconEl) {
            iconEl.dataset.origIcon = iconEl.dataset.origIcon || iconEl.innerHTML;
            iconEl.innerHTML = '&#x1F512;';
          } else if (iconEl && iconEl.dataset.origIcon) {
            iconEl.innerHTML = iconEl.dataset.origIcon;
          }
        });

        document.querySelectorAll('.connector[data-conn]').forEach(conn => {
          const [parent, child] = conn.dataset.conn.split('-');
          const childBlocked = (FEATURE_DEPENDENCIES[child] || []).some(p => !selections[p]);
          conn.classList.toggle('active', selections[parent] && selections[child]);
          conn.classList.toggle('locked', childBlocked);
        });

        document.querySelectorAll('.fork-top[data-conn]').forEach(fork => {
          const [parent, child] = fork.dataset.conn.split('-');
          const childBlocked = (FEATURE_DEPENDENCIES[child] || []).some(p => !selections[p]);
          fork.classList.toggle('active', selections[parent] && selections[child]);
          fork.classList.toggle('locked', childBlocked);
        });
      }

      function updateDependencyUi(selections) {
        updateSkillTreeVisuals(selections);
      }

      function updateAll(changedFeature = null, enabled = null) {
        const selections = readSelections();
        applyDependencyRules(selections, changedFeature, enabled);
        setSelections(selections);
        updateDependencyUi(selections);
        const matchingProfile = detectMatchingProfile(selections);
        highlightProfile(matchingProfile);
        updateProfileStatus(matchingProfile);
        const selectedProfile = matchingProfile || "custom";
        const size = computeSize(selections);
        updateSizeDisplay(size);
        updateOutputs(selections, selectedProfile, matchingProfile);
        updateBuildLink(selections, selectedProfile);
      }

      function flashCopyButton(btn) {
        btn.classList.add('copied');
        const orig = btn.textContent;
        btn.textContent = 'Copied';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.textContent = orig;
        }, 1200);
      }

      function setupEvents() {
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.addEventListener("click", () => applyProfile(btn.dataset.preset));
        });

        document.querySelectorAll("input[data-feature]").forEach((checkbox) => {
          checkbox.addEventListener("change", (event) => {
            const feature = event.target.dataset.feature;
            updateAll(feature, event.target.checked);
          });
        });

        const copyCommand = document.getElementById("copy-command");
        copyCommand.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("command-output").value);
          flashCopyButton(copyCommand);
        });

        const copyFlags = document.getElementById("copy-flags");
        copyFlags.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("flags-output").value);
          flashCopyButton(copyFlags);
        });

        const copyShare = document.getElementById("copy-share");
        copyShare.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("share-output").value);
          flashCopyButton(copyShare);
        });

        document.getElementById("download-ini").addEventListener("click", () => {
          const content = document.getElementById("ini-output").value;
          const blob = new Blob([content], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "platformio-custom.ini";
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
        });
      }

      async function loadScreenPreviews() {
        const grid = document.getElementById("preview-grid");
        const meta = document.getElementById("preview-meta");
        const manifestUrl = "./screen-previews/manifest.json";

        try {
          const response = await fetch(manifestUrl, { cache: "no-store" });
          if (!response.ok) throw new Error(`manifest fetch failed (${response.status})`);
          const manifest = await response.json();

          const files = Array.isArray(manifest.files) ? manifest.files : [];
          if (files.length === 0) throw new Error("manifest is empty");

          const cards = files
            .map((file) => {
              const label = file.label || file.name || "Preview";
              const src = `./screen-previews/${file.name}`;
              return `<figure class="preview-card"><img src="${src}" alt="${label}" loading="lazy" /><figcaption>${label}</figcaption></figure>`;
            })
            .join("");

          grid.innerHTML = cards;
          const generatedAt = manifest.generated_at
            ? `Updated ${new Date(manifest.generated_at).toLocaleString()}`
            : "Updated recently";
          meta.textContent = generatedAt;
        } catch (error) {
          grid.innerHTML = '<div class="note-bar">Preview images are publishing. Check back in a minute.</div>';
          meta.textContent = "";
        }
      }

      setupEvents();
      const initialState = parseInitialStateFromUrl();
      baseProfile = initialState.initialProfile;
      setSelections(initialState.selections);
      highlightProfile(baseProfile);
      updateAll();
      loadScreenPreviews();
    </script>
  </body>
</html>
