<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrossPoint Reader — Skill Tree</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&family=IBM+Plex+Mono:wght@400;500&display=swap");

      :root {
        --blk: #111;
        --dk: #333;
        --md: #666;
        --lt: #999;
        --pale: #bbb;
        --bone: #d4d4d4;
        --fog: #e8e8e8;
        --paper: #f2f2f2;
        --white: #fafafa;
        --px: 2px;
        --bevel-hi: #ddd;
        --bevel-lo: #888;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: 'Silkscreen', 'IBM Plex Mono', monospace;
        background: var(--paper);
        color: var(--blk);
        min-height: 100vh;
        image-rendering: pixelated;
        -webkit-font-smoothing: none;
        -moz-osx-font-smoothing: unset;
        background-image:
          repeating-linear-gradient(
            0deg,
            transparent,
            transparent 7px,
            rgba(0,0,0,0.018) 7px,
            rgba(0,0,0,0.018) 8px
          ),
          repeating-linear-gradient(
            90deg,
            transparent,
            transparent 7px,
            rgba(0,0,0,0.018) 7px,
            rgba(0,0,0,0.018) 8px
          );
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 32px 16px 64px;
      }

      /* ── Pixel bevel mixin ── */
      .bevel {
        border: var(--px) solid var(--blk);
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-hi),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-lo);
      }

      .bevel-inset {
        border: var(--px) solid var(--blk);
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-lo),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-hi);
      }

      /* ── Header ── */
      .header {
        text-align: center;
        margin-bottom: 24px;
        padding: 20px 16px 18px;
        background: var(--white);
      }

      .header-eyebrow {
        font-size: 8px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        color: var(--md);
        margin-bottom: 8px;
      }

      .header h1 {
        font-size: clamp(16px, 3.2vw, 26px);
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--blk);
        line-height: 1.6;
      }

      .header-sub {
        font-size: 8px;
        color: var(--dk);
        margin-top: 8px;
        line-height: 1.6;
      }

      /* ── Flash meter ── */
      .flash-meter {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: var(--white);
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .flash-label {
        font-size: 8px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--md);
      }

      .flash-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--blk);
        min-width: 72px;
      }

      .flash-track {
        flex: 1;
        min-width: 140px;
        height: 16px;
        background: var(--fog);
        overflow: hidden;
        /* Pixelated block look */
        background-image: repeating-linear-gradient(
          90deg,
          var(--fog) 0px,
          var(--fog) 6px,
          var(--bone) 6px,
          var(--bone) 8px
        );
      }

      .flash-fill {
        height: 100%;
        background: repeating-linear-gradient(
          90deg,
          var(--blk) 0px,
          var(--blk) 6px,
          var(--dk) 6px,
          var(--dk) 8px
        );
        transition: width 0.2s steps(20);
      }

      .flash-fill.over {
        background: repeating-linear-gradient(
          90deg,
          var(--blk) 0px,
          var(--blk) 4px,
          var(--md) 4px,
          var(--md) 8px
        );
      }

      .flash-context {
        font-size: 8px;
        color: var(--md);
      }

      /* ── Loadout ── */
      .loadout-bar {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 4px;
        flex-wrap: wrap;
      }

      .loadout-label {
        font-size: 8px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--dk);
        margin-right: 4px;
      }

      .preset-btn {
        background: var(--white);
        border: var(--px) solid var(--blk);
        color: var(--blk);
        padding: 6px 14px;
        font-family: 'Silkscreen', monospace;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
        transition: none;
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-hi),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-lo);
      }

      .preset-btn:hover {
        background: var(--fog);
      }

      .preset-btn:active {
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-lo),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-hi);
      }

      .preset-btn.active {
        background: var(--blk);
        color: var(--white);
        box-shadow:
          inset var(--px) var(--px) 0 var(--dk),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 #000;
      }

      .profile-status {
        font-size: 8px;
        color: var(--md);
        margin-bottom: 20px;
        padding-left: 2px;
      }

      .profile-status strong {
        color: var(--blk);
        font-weight: 700;
      }

      /* ── Skill Tree ── */
      .skill-tree {
        margin-bottom: 24px;
        padding: 20px 16px 16px;
        background: var(--white);
        position: relative;
        overflow: hidden;
      }

      /* Dither overlay */
      .skill-tree::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0.04;
        background: repeating-conic-gradient(var(--blk) 0% 25%, transparent 0% 50%) 0 0 / 4px 4px;
      }

      .graph-links {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
      }

      .graph-edge {
        stroke: var(--bone);
        stroke-width: 2;
        shape-rendering: crispEdges;
        transition: stroke 0.15s steps(4);
      }

      .graph-edge.active {
        stroke: var(--blk);
        stroke-width: 3;
      }

      .graph-edge.locked {
        stroke: var(--pale);
        stroke-dasharray: 4 4;
      }

      .graph-layout {
        position: relative;
        z-index: 1;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 14px 10px;
        align-items: start;
      }

      .graph-root {
        grid-column: 1 / -1;
        justify-self: center;
        margin-bottom: 6px;
      }

      .graph-hub {
        justify-self: center;
      }

      .graph-lane {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .lane-header {
        font-size: 8px;
        font-weight: 700;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: var(--dk);
        margin-bottom: 2px;
        padding: 3px 8px;
        background: var(--fog);
        border: 1px solid var(--bone);
      }

      /* ── Nodes ── */
      .skill-node,
      .anchor-node {
        position: relative;
        width: 100%;
        max-width: 130px;
        cursor: pointer;
        -webkit-user-select: none;
        user-select: none;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .anchor-node {
        cursor: default;
      }

      .skill-node input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
      }

      .node-ring {
        width: 48px;
        height: 48px;
        border: var(--px) solid var(--dk);
        background: var(--white);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.1s steps(4), border-color 0.1s steps(4);
        position: relative;
        margin-bottom: 4px;
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-hi),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-lo);
      }

      .graph-root .node-ring {
        width: 56px;
        height: 56px;
        border-color: var(--blk);
        border-width: 3px;
        background: var(--fog);
      }

      .graph-hub .node-ring {
        width: 42px;
        height: 42px;
      }

      .node-icon {
        font-size: 16px;
        line-height: 1;
        color: var(--dk);
        filter: grayscale(1) contrast(1.8);
        transition: filter 0.1s steps(4);
        z-index: 1;
      }

      .graph-root .node-icon {
        font-size: 18px;
      }

      /* Active */
      .skill-node.active .node-ring,
      .anchor-node.active .node-ring {
        background: var(--blk);
        border-color: var(--blk);
        box-shadow:
          inset var(--px) var(--px) 0 var(--dk),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 #000;
      }

      .skill-node.active .node-icon,
      .anchor-node.active .node-icon {
        color: var(--white);
        filter: grayscale(1) contrast(1.2) invert(1);
      }

      /* Locked */
      .skill-node.locked .node-ring {
        background: var(--fog);
        border-color: var(--pale);
        border-style: dashed;
        box-shadow: none;
        /* Dither fill for locked state */
        background-image: repeating-conic-gradient(var(--bone) 0% 25%, var(--fog) 0% 50%);
        background-size: 4px 4px;
      }

      .skill-node.locked .node-icon {
        color: var(--lt);
        filter: grayscale(1) contrast(0.8);
        font-size: 12px;
      }

      .node-label {
        text-align: center;
        font-size: 8px;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--dk);
        line-height: 1.4;
        transition: color 0.1s steps(4);
        max-width: 120px;
      }

      .skill-node.active .node-label,
      .anchor-node.active .node-label {
        color: var(--blk);
      }

      .skill-node.locked .node-label {
        color: var(--lt);
      }

      .node-size {
        text-align: center;
        font-size: 8px;
        font-family: 'IBM Plex Mono', monospace;
        color: var(--md);
        margin-top: 1px;
      }

      .skill-node.active .node-size,
      .anchor-node.active .node-size {
        color: var(--dk);
      }

      .graph-root .node-size {
        color: var(--dk);
      }

      .skill-node.dependent-node {
        transform: translateX(12px);
      }

      /* Note nodes — smaller, subordinate */
      .graph-note {
        max-width: 140px;
        cursor: default;
      }

      .graph-note .node-ring {
        width: 28px;
        height: 28px;
        margin-bottom: 2px;
        border-style: dashed;
        border-color: var(--pale);
        background: var(--paper);
        box-shadow: none;
      }

      .graph-note .node-icon {
        font-size: 10px;
        filter: grayscale(1);
      }

      .graph-note .node-label {
        font-size: 7px;
        font-weight: 400;
        text-transform: none;
        color: var(--lt);
        letter-spacing: 0;
        line-height: 1.3;
      }

      .graph-note.active .node-ring {
        border-color: var(--dk);
        background: var(--fog);
      }

      .graph-note.active .node-label {
        color: var(--dk);
      }

      /* ── Tooltip ── */
      .skill-node .tooltip {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--white);
        border: var(--px) solid var(--blk);
        padding: 8px 10px;
        min-width: 170px;
        max-width: 220px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.05s steps(2);
        z-index: 100;
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-hi),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-lo),
          4px 4px 0 rgba(0,0,0,0.15);
      }

      .skill-node:hover .tooltip {
        opacity: 1;
      }

      .tooltip-title {
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--blk);
        margin-bottom: 4px;
      }

      .tooltip-desc {
        font-size: 8px;
        color: var(--dk);
        line-height: 1.5;
        margin-bottom: 4px;
        font-weight: 400;
      }

      .tooltip-size {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 8px;
        color: var(--md);
      }

      .tooltip-req {
        font-size: 8px;
        color: var(--lt);
        margin-top: 3px;
        font-style: italic;
      }

      .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: var(--blk);
      }

      /* ── Panels ── */
      .panel {
        background: var(--white);
        border: var(--px) solid var(--blk);
        padding: 14px 16px;
        margin-bottom: 12px;
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-hi),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-lo);
      }

      .panel-heading {
        font-size: 9px;
        font-weight: 700;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--blk);
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--bone);
      }

      .outputs-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .output-label {
        font-size: 8px;
        font-weight: 700;
        color: var(--dk);
        margin-bottom: 4px;
        text-transform: uppercase;
      }

      .output textarea {
        width: 100%;
        min-height: 64px;
        background: var(--fog);
        border: var(--px) solid var(--dk);
        padding: 6px 8px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 10px;
        color: var(--blk);
        resize: vertical;
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-lo),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-hi);
      }

      .output textarea:focus {
        outline: none;
        border-color: var(--blk);
      }

      .actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .btn {
        border: var(--px) solid var(--blk);
        padding: 6px 12px;
        font-family: 'Silkscreen', monospace;
        font-size: 8px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        text-decoration: none;
        text-align: center;
        transition: none;
      }

      .btn-outline {
        background: var(--white);
        color: var(--blk);
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-hi),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-lo);
      }

      .btn-outline:hover {
        background: var(--fog);
      }

      .btn-outline:active {
        box-shadow:
          inset var(--px) var(--px) 0 var(--bevel-lo),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 var(--bevel-hi);
      }

      .btn-outline.copied {
        background: var(--blk);
        color: var(--white);
      }

      .btn-solid {
        background: var(--blk);
        color: var(--white);
        box-shadow:
          inset var(--px) var(--px) 0 var(--dk),
          inset calc(-1 * var(--px)) calc(-1 * var(--px)) 0 #000;
      }

      .btn-solid:hover {
        background: var(--dk);
      }

      .info-bar {
        margin-top: 10px;
        padding: 6px 10px;
        border-left: 3px solid var(--blk);
        font-size: 8px;
        color: var(--dk);
        background: var(--fog);
        line-height: 1.5;
      }

      /* ── Companion ── */
      .companion-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .companion-title {
        font-size: 10px;
        font-weight: 700;
      }

      .companion-desc {
        font-size: 8px;
        color: var(--dk);
        margin-top: 3px;
        line-height: 1.5;
      }

      .companion-desc code {
        background: var(--fog);
        border: 1px solid var(--bone);
        padding: 0 3px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 8px;
      }

      /* ── Preview ── */
      .preview-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .preview-sub {
        font-size: 8px;
        color: var(--md);
        margin-top: 3px;
      }

      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px;
      }

      .preview-card {
        border: var(--px) solid var(--dk);
        overflow: hidden;
        background: var(--fog);
      }

      .preview-card img {
        width: 100%;
        height: auto;
        display: block;
        filter: grayscale(1);
        image-rendering: pixelated;
      }

      .preview-card figcaption {
        padding: 4px 6px;
        font-size: 7px;
        color: var(--dk);
        border-top: 1px solid var(--bone);
      }

      .preview-meta {
        margin-top: 6px;
        font-size: 7px;
        color: var(--lt);
      }

      .footer {
        text-align: center;
        margin-top: 20px;
        font-size: 7px;
        color: var(--lt);
        letter-spacing: 0.05em;
      }

      .note-bar {
        padding: 6px 10px;
        border-left: 3px solid var(--dk);
        font-size: 8px;
        color: var(--dk);
        background: var(--fog);
      }

      /* ── Hover ── */
      .skill-node:not(.locked):hover .node-ring {
        border-color: var(--blk);
        background: var(--fog);
      }

      .skill-node.active:hover .node-ring {
        background: var(--dk);
      }

      /* ── Responsive ── */
      @media (max-width: 800px) {
        .graph-layout {
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 12px 8px;
        }
        .graph-root { margin-bottom: 6px; }
        .skill-node.dependent-node { transform: translateX(8px); }
        .outputs-grid { grid-template-columns: 1fr; }
      }

      @media (max-width: 480px) {
        .graph-layout {
          grid-template-columns: 1fr;
          gap: 10px;
        }
        .graph-root { justify-self: center; }
        .graph-hub { justify-self: center; }
        .graph-lane { gap: 8px; }
        .skill-node.dependent-node { transform: translateX(0); }
        .flash-meter { flex-direction: column; align-items: stretch; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header bevel">
        <div class="header-eyebrow">CrossPoint Reader</div>
        <h1>Capability Tree</h1>
        <div class="header-sub">
          Compile-time feature flags. Toggle nodes to configure your firmware build.
        </div>
      </div>

      <!-- Flash meter -->
      <div class="flash-meter bevel">
        <span class="flash-label">Flash</span>
        <span class="flash-value" id="size-value">6.0 MB</span>
        <div class="flash-track bevel-inset">
          <div class="flash-fill" id="size-bar" style="width: 0%"></div>
        </div>
        <span class="flash-context" id="size-context">94% of 6.4 MB</span>
      </div>

      <!-- Loadout -->
      <div class="loadout-bar">
        <span class="loadout-label">Loadout</span>
        <button class="preset-btn" data-preset="lean">Lean</button>
        <button class="preset-btn active" data-preset="standard">Standard</button>
        <button class="preset-btn" data-preset="full">Full</button>
      </div>
      <div class="profile-status" id="profile-status"></div>

      <!-- Skill Tree -->
      <div class="skill-tree bevel" id="skill-tree">
        <svg class="graph-links" id="graph-links" aria-hidden="true"></svg>
        <div class="graph-layout">
          <!-- Root -->
          <div class="graph-root anchor-node active" data-node-id="root">
            <div class="node-ring"><span class="node-icon">&#x25C6;</span></div>
            <div class="node-label">CrossPoint Core</div>
            <div class="node-size">1.66 MB base</div>
          </div>

          <!-- Hub row -->
          <div class="graph-hub anchor-node" data-node-id="reading_hub">
            <div class="node-ring"><span class="node-icon">&#x25A0;</span></div>
            <div class="node-label">Reading</div>
          </div>
          <div class="graph-hub anchor-node" data-node-id="interface_hub">
            <div class="node-ring"><span class="node-icon">&#x25B2;</span></div>
            <div class="node-label">Interface</div>
          </div>
          <div class="graph-hub anchor-node" data-node-id="network_hub">
            <div class="node-ring"><span class="node-icon">&#x25CF;</span></div>
            <div class="node-label">Network</div>
          </div>
          <div class="graph-hub anchor-node" data-node-id="extras_hub">
            <div class="node-ring"><span class="node-icon">&#x2605;</span></div>
            <div class="node-label">Roadmap</div>
          </div>

          <!-- ── Reading lane ── -->
          <div class="graph-lane" data-lane="reading">
            <div class="lane-header">Reading</div>

            <label class="skill-node" data-feature="epub_support" data-node-id="epub_support">
              <input type="checkbox" id="epub_support" data-feature="epub_support" />
              <div class="tooltip">
                <div class="tooltip-title">EPUB Support</div>
                <div class="tooltip-desc">EPUB e-book reader with CSS, images, and chapter navigation</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x25A3;</span></div>
              <div class="node-label">EPUB</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node dependent-node" data-feature="hyphenation" data-node-id="hyphenation">
              <input type="checkbox" id="hyphenation" data-feature="hyphenation" />
              <div class="tooltip">
                <div class="tooltip-title">Hyphenation</div>
                <div class="tooltip-desc">Language-aware hyphenation for justified EPUB text</div>
                <div class="tooltip-size"></div>
                <div class="tooltip-req">Requires EPUB Support</div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2500;</span></div>
              <div class="node-label">Hyphen</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="markdown" data-node-id="markdown">
              <input type="checkbox" id="markdown" data-feature="markdown" />
              <div class="tooltip">
                <div class="tooltip-title">Markdown</div>
                <div class="tooltip-desc">Markdown and Obsidian vault reading support</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x00B6;</span></div>
              <div class="node-label">Markdown</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="xtc_support" data-node-id="xtc_support">
              <input type="checkbox" id="xtc_support" data-feature="xtc_support" />
              <div class="tooltip">
                <div class="tooltip-title">XTC Support</div>
                <div class="tooltip-desc">XTC format reader with chapter navigation</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x25C7;</span></div>
              <div class="node-label">XTC</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="todo_planner" data-node-id="todo_planner">
              <input type="checkbox" id="todo_planner" data-feature="todo_planner" />
              <div class="tooltip">
                <div class="tooltip-title">Agenda</div>
                <div class="tooltip-desc">Daily markdown notes and task tracking</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2713;</span></div>
              <div class="node-label">Agenda</div>
              <div class="node-size"></div>
            </label>
          </div>

          <!-- ── Interface lane ── -->
          <div class="graph-lane" data-lane="interface">
            <div class="lane-header">UI / Sleep</div>

            <label class="skill-node" data-feature="extended_fonts" data-node-id="extended_fonts">
              <input type="checkbox" id="extended_fonts" data-feature="extended_fonts" />
              <div class="tooltip">
                <div class="tooltip-title">Custom Fonts</div>
                <div class="tooltip-desc">12/16/18pt fonts and OpenDyslexic support</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">A</span></div>
              <div class="node-label">Fonts</div>
              <div class="node-size"></div>
            </label>

            <div class="graph-note anchor-node" data-node-id="specific_fonts_note">
              <div class="node-ring"><span class="node-icon">&#x25AA;</span></div>
              <div class="node-label">Targeted fonts</div>
            </div>

            <label class="skill-node" data-feature="home_media_picker" data-node-id="home_media_picker">
              <input type="checkbox" id="home_media_picker" data-feature="home_media_picker" />
              <div class="tooltip">
                <div class="tooltip-title">Home Screen</div>
                <div class="tooltip-desc">Streamlined home UI with horizontal book shelf + vertical menu</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2302;</span></div>
              <div class="node-label">Home UI</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="lyra_theme" data-node-id="lyra_theme">
              <input type="checkbox" id="lyra_theme" data-feature="lyra_theme" />
              <div class="tooltip">
                <div class="tooltip-title">Lyra Theme</div>
                <div class="tooltip-desc">Alternative UI theme with refined spacing and layout</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x2606;</span></div>
              <div class="node-label">Lyra</div>
              <div class="node-size"></div>
            </label>

            <div class="graph-note anchor-node" data-node-id="fork_drift_note">
              <div class="node-ring"><span class="node-icon">&#x21BB;</span></div>
              <div class="node-label">Fork-drift</div>
            </div>

            <div class="graph-note anchor-node" data-node-id="future_themes_note">
              <div class="node-ring"><span class="node-icon">&#x22EF;</span></div>
              <div class="node-label">{themes}</div>
            </div>

            <div class="graph-note anchor-node" data-node-id="dark_theme_note">
              <div class="node-ring"><span class="node-icon">&#x25D0;</span></div>
              <div class="node-label">Dark mode</div>
            </div>

            <label class="skill-node" data-feature="image_sleep" data-node-id="image_sleep">
              <input type="checkbox" id="image_sleep" data-feature="image_sleep" />
              <div class="tooltip">
                <div class="tooltip-title">Sleep Screen</div>
                <div class="tooltip-desc">PNG and JPEG sleep screen support (BMP always included)</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x263E;</span></div>
              <div class="node-label">Sleep Art</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="web_pokedex_plugin" data-node-id="web_pokedex_plugin">
              <input type="checkbox" id="web_pokedex_plugin" data-feature="web_pokedex_plugin" />
              <div class="tooltip">
                <div class="tooltip-title">Pokedex Sleep</div>
                <div class="tooltip-desc">Browser-side Pokemon wallpaper generator at /plugins/pokedex</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x26A1;</span></div>
              <div class="node-label">Pokedex</div>
              <div class="node-size"></div>
            </label>
          </div>

          <!-- ── Network lane ── -->
          <div class="graph-lane" data-lane="network">
            <div class="lane-header">Network</div>

            <label class="skill-node" data-feature="background_server" data-node-id="background_server">
              <input type="checkbox" id="background_server" data-feature="background_server" />
              <div class="tooltip">
                <div class="tooltip-title">Web Server</div>
                <div class="tooltip-desc">Background web server for file management</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x25A1;</span></div>
              <div class="node-label">Server</div>
              <div class="node-size"></div>
            </label>

            <div class="graph-note anchor-node" data-node-id="webserver_always_on_note">
              <div class="node-ring"><span class="node-icon">&#x221E;</span></div>
              <div class="node-label">Always on</div>
            </div>

            <div class="graph-note anchor-node" data-node-id="webserver_on_charge_note">
              <div class="node-ring"><span class="node-icon">&#x26A1;</span></div>
              <div class="node-label">On charge</div>
            </div>

            <label class="skill-node" data-feature="ota_updates" data-node-id="ota_updates">
              <input type="checkbox" id="ota_updates" data-feature="ota_updates" />
              <div class="tooltip">
                <div class="tooltip-title">OTA Updates</div>
                <div class="tooltip-desc">Over-the-air firmware updates via WiFi</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x25B2;</span></div>
              <div class="node-label">OTA</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node" data-feature="integrations" data-node-id="integrations">
              <input type="checkbox" id="integrations" data-feature="integrations" />
              <div class="tooltip">
                <div class="tooltip-title">Integrations</div>
                <div class="tooltip-desc">Shared runtime hooks for remote sync integrations</div>
                <div class="tooltip-size"></div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x253C;</span></div>
              <div class="node-label">Sync Base</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node dependent-node" data-feature="koreader_sync" data-node-id="koreader_sync">
              <input type="checkbox" id="koreader_sync" data-feature="koreader_sync" />
              <div class="tooltip">
                <div class="tooltip-title">KOReader Sync</div>
                <div class="tooltip-desc">Sync reading progress with KOReader</div>
                <div class="tooltip-size"></div>
                <div class="tooltip-req">Requires Integrations</div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x25B6;</span></div>
              <div class="node-label">KOReader</div>
              <div class="node-size"></div>
            </label>

            <label class="skill-node dependent-node" data-feature="calibre_sync" data-node-id="calibre_sync">
              <input type="checkbox" id="calibre_sync" data-feature="calibre_sync" />
              <div class="tooltip">
                <div class="tooltip-title">Calibre Sync</div>
                <div class="tooltip-desc">Calibre OPDS browser and metadata sync settings</div>
                <div class="tooltip-size"></div>
                <div class="tooltip-req">Requires Integrations</div>
              </div>
              <div class="node-ring"><span class="node-icon">&#x25C0;</span></div>
              <div class="node-label">Calibre</div>
              <div class="node-size"></div>
            </label>
          </div>

          <!-- ── Extras lane ── -->
          <div class="graph-lane" data-lane="extras">
            <div class="lane-header">Canvas</div>

            <div class="graph-note anchor-node" data-node-id="obsidian_xte_sync_note">
              <div class="node-ring"><span class="node-icon">&#x25AB;</span></div>
              <div class="node-label">Obsidian XTE sync</div>
            </div>

            <div class="graph-note anchor-node" data-node-id="feature_store_note">
              <div class="node-ring"><span class="node-icon">&#x25AB;</span></div>
              <div class="node-label">Feature store: select then pull OTA</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Build Outputs -->
      <div class="panel">
        <div class="panel-heading">Build Output</div>
        <div class="outputs-grid">
          <div class="output">
            <div class="output-label">Build flags</div>
            <textarea id="flags-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">Generate command</div>
            <textarea id="command-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">platformio-custom.ini</div>
            <textarea id="ini-output" readonly></textarea>
          </div>
          <div class="output">
            <div class="output-label">Share URL</div>
            <textarea id="share-output" readonly></textarea>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-outline" id="copy-command">Copy Cmd</button>
          <button class="btn btn-outline" id="copy-flags">Copy Flags</button>
          <button class="btn btn-outline" id="copy-share">Copy URL</button>
          <button class="btn btn-outline" id="download-ini">Download .ini</button>
          <a class="btn btn-solid" id="build-link" href="#" target="_blank" rel="noopener">Build on GitHub</a>
        </div>
        <div class="info-bar">
          Compile-time dependencies are enforced automatically. Canvas notes are directional and do not hard-block builds.
        </div>
      </div>

      <!-- Companion -->
      <div class="panel">
        <div class="panel-heading">Companion Plugins</div>
        <div class="companion-row">
          <div>
            <div class="companion-title">Grayscale Pokedex Wallpaper</div>
            <div class="companion-desc">
              Generate wallpapers from Pokemon data. Upload to
              <code>/sleep/pokedex</code> for Sleep Source mode.
            </div>
          </div>
          <a class="btn btn-outline" href="../plugins/x4-pokedex-grayscale/" target="_blank" rel="noopener">Open</a>
        </div>
      </div>

      <!-- Preview -->
      <div class="panel">
        <div class="preview-top">
          <div>
            <div class="panel-heading" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0">Screen Previews</div>
            <div class="preview-sub">Auto-generated from the latest firmware UI harness.</div>
          </div>
          <a class="btn btn-outline" href="./screen-previews/" target="_blank" rel="noopener">Open</a>
        </div>
        <div class="preview-grid" id="preview-grid"></div>
        <div class="preview-meta" id="preview-meta"></div>
      </div>

      <div class="footer">Future: this picker will live inside the OTA update menu.</div>
    </div>

    <script>
      const FEATURES = {
        extended_fonts: {
          sizeKb: 3630,
          flag: "ENABLE_EXTENDED_FONTS",
          default: true,
        },
        image_sleep: {
          sizeKb: 0,
          flag: "ENABLE_IMAGE_SLEEP",
          default: true,
        },
        markdown: {
          sizeKb: 231,
          flag: "ENABLE_MARKDOWN",
          default: true,
        },
        integrations: {
          sizeKb: 0,
          flag: "ENABLE_INTEGRATIONS",
          default: false,
        },
        koreader_sync: {
          sizeKb: 142,
          flag: "ENABLE_KOREADER_SYNC",
          default: false,
        },
        calibre_sync: {
          sizeKb: 223,
          flag: "ENABLE_CALIBRE_SYNC",
          default: false,
        },
        background_server: {
          sizeKb: 0,
          flag: "ENABLE_BACKGROUND_SERVER",
          default: true,
        },
        home_media_picker: {
          sizeKb: -4,
          flag: "ENABLE_HOME_MEDIA_PICKER",
          default: true,
        },
        web_pokedex_plugin: {
          sizeKb: -4,
          flag: "ENABLE_WEB_POKEDEX_PLUGIN",
          default: false,
        },
        epub_support: {
          sizeKb: 157,
          flag: "ENABLE_EPUB_SUPPORT",
          default: true,
        },
        hyphenation: {
          sizeKb: 447,
          flag: "ENABLE_HYPHENATION",
          default: true,
        },
        xtc_support: {
          sizeKb: 13,
          flag: "ENABLE_XTC_SUPPORT",
          default: true,
        },
        lyra_theme: {
          sizeKb: 5,
          flag: "ENABLE_LYRA_THEME",
          default: true,
        },
        ota_updates: {
          sizeKb: 230,
          flag: "ENABLE_OTA_UPDATES",
          default: true,
        },
        todo_planner: {
          sizeKb: 6,
          flag: "ENABLE_TODO_PLANNER",
          default: false,
        },
      };

      const BASE_SIZE_MB = 1.66;
      const MAX_FLASH_MB = 6.4;
      const FEATURE_DEPENDENCIES = {
        koreader_sync: ["integrations"],
        calibre_sync: ["integrations"],
        hyphenation: ["epub_support"],
      };

      const HUB_FEATURES = {
        reading_hub: ["markdown", "xtc_support", "epub_support", "hyphenation", "todo_planner"],
        interface_hub: ["extended_fonts", "home_media_picker", "lyra_theme", "image_sleep", "web_pokedex_plugin"],
        network_hub: ["background_server", "ota_updates", "integrations", "koreader_sync", "calibre_sync"],
        extras_hub: ["ota_updates", "integrations", "home_media_picker"],
      };

      const NOTE_FEATURES = {
        specific_fonts_note: ["extended_fonts"],
        dark_theme_note: ["lyra_theme"],
        fork_drift_note: ["home_media_picker"],
        future_themes_note: ["home_media_picker", "lyra_theme"],
        webserver_always_on_note: ["background_server"],
        webserver_on_charge_note: ["background_server"],
        obsidian_xte_sync_note: ["integrations"],
        feature_store_note: ["ota_updates"],
      };

      const GRAPH_EDGES = [
        { from: "root", to: "reading_hub" },
        { from: "root", to: "interface_hub" },
        { from: "root", to: "network_hub" },
        { from: "root", to: "extras_hub" },
        { from: "reading_hub", to: "markdown" },
        { from: "reading_hub", to: "xtc_support" },
        { from: "reading_hub", to: "epub_support" },
        { from: "epub_support", to: "hyphenation" },
        { from: "reading_hub", to: "todo_planner" },
        { from: "markdown", to: "todo_planner" },
        { from: "interface_hub", to: "extended_fonts" },
        { from: "extended_fonts", to: "specific_fonts_note" },
        { from: "interface_hub", to: "home_media_picker" },
        { from: "home_media_picker", to: "lyra_theme" },
        { from: "home_media_picker", to: "fork_drift_note" },
        { from: "home_media_picker", to: "future_themes_note" },
        { from: "lyra_theme", to: "dark_theme_note" },
        { from: "interface_hub", to: "image_sleep" },
        { from: "image_sleep", to: "web_pokedex_plugin" },
        { from: "network_hub", to: "background_server" },
        { from: "background_server", to: "webserver_always_on_note" },
        { from: "background_server", to: "webserver_on_charge_note" },
        { from: "network_hub", to: "ota_updates" },
        { from: "network_hub", to: "integrations" },
        { from: "integrations", to: "koreader_sync" },
        { from: "integrations", to: "calibre_sync" },
        { from: "integrations", to: "obsidian_xte_sync_note" },
        { from: "ota_updates", to: "feature_store_note" },
        { from: "extras_hub", to: "obsidian_xte_sync_note" },
        { from: "extras_hub", to: "feature_store_note" },
      ];

      const PROFILES = {
        lean: {},
        standard: {
          extended_fonts: true,
          image_sleep: true,
          epub_support: true,
          hyphenation: true,
          xtc_support: true,
          lyra_theme: true,
          ota_updates: true,
          background_server: true,
          home_media_picker: true,
        },
        full: {
          extended_fonts: true,
          image_sleep: true,
          markdown: true,
          integrations: true,
          koreader_sync: true,
          calibre_sync: true,
          epub_support: true,
          hyphenation: true,
          xtc_support: true,
          lyra_theme: true,
          ota_updates: true,
          todo_planner: true,
          background_server: true,
          home_media_picker: true,
          web_pokedex_plugin: true,
        },
      };

      let baseProfile = "standard";

      function getRepoInfo() {
        const host = window.location.hostname;
        const pathParts = window.location.pathname.split("/").filter(Boolean);
        if (host.endsWith("github.io") && pathParts.length > 0) {
          return { owner: host.split(".")[0], repo: pathParts[0] };
        }
        return { owner: "Unintendedsideeffects", repo: "crosspoint-reader" };
      }

      function parseBooleanParam(value) {
        if (value == null) return null;
        const normalized = value.toLowerCase();
        if (normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on") return true;
        if (normalized === "0" || normalized === "false" || normalized === "no" || normalized === "off") return false;
        return null;
      }

      function profileToSelections(name) {
        const profile = PROFILES[name] || {};
        const selections = {};
        Object.keys(FEATURES).forEach((feature) => {
          selections[feature] = Boolean(profile[feature]);
        });
        return selections;
      }

      function setSelections(selections) {
        Object.keys(FEATURES).forEach((feature) => {
          const checkbox = document.getElementById(feature);
          checkbox.checked = Boolean(selections[feature]);
        });
      }

      function enableDependencies(feature, selections) {
        const parents = FEATURE_DEPENDENCIES[feature] || [];
        parents.forEach((parent) => {
          if (!selections[parent]) {
            selections[parent] = true;
            enableDependencies(parent, selections);
          }
        });
      }

      function disableDependents(feature, selections) {
        Object.keys(FEATURE_DEPENDENCIES).forEach((child) => {
          const parents = FEATURE_DEPENDENCIES[child] || [];
          if (parents.includes(feature) && selections[child]) {
            selections[child] = false;
            disableDependents(child, selections);
          }
        });
      }

      function applyDependencyRules(selections, changedFeature, enabled) {
        if (changedFeature) {
          if (enabled) {
            enableDependencies(changedFeature, selections);
          } else {
            disableDependents(changedFeature, selections);
          }
        }
        Object.keys(FEATURE_DEPENDENCIES).forEach((child) => {
          const parents = FEATURE_DEPENDENCIES[child] || [];
          const missingParent = parents.some((parent) => !selections[parent]);
          if (missingParent) selections[child] = false;
        });
      }

      function highlightProfile(profileName) {
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.preset === profileName);
        });
      }

      function detectMatchingProfile(selections) {
        for (const [profileName] of Object.entries(PROFILES)) {
          const profileSelections = profileToSelections(profileName);
          const isMatch = Object.keys(FEATURES).every(
            (feature) => selections[feature] === profileSelections[feature]
          );
          if (isMatch) return profileName;
        }
        return null;
      }

      function applyProfile(name) {
        if (!PROFILES[name]) return;
        baseProfile = name;
        setSelections(profileToSelections(name));
        highlightProfile(name);
        updateAll();
      }

      function updateProfileStatus(matchingProfile) {
        const status = document.getElementById("profile-status");
        if (matchingProfile) {
          status.innerHTML = `Active loadout: <strong>${matchingProfile}</strong>`;
        } else {
          status.innerHTML = `Active loadout: <strong>custom</strong> (modified from ${baseProfile})`;
        }
      }

      function readSelections() {
        const selections = {};
        Object.keys(FEATURES).forEach((feature) => {
          selections[feature] = document.getElementById(feature).checked;
        });
        return selections;
      }

      function computeSize(selections) {
        let size = BASE_SIZE_MB;
        Object.keys(FEATURES).forEach((feature) => {
          if (selections[feature]) size += FEATURES[feature].sizeKb / 1024;
        });
        return size;
      }

      function buildFlags(selections) {
        const flags = [];
        Object.keys(FEATURES).forEach((feature) => {
          const flag = FEATURES[feature].flag;
          flags.push(`-D${flag}=${selections[feature] ? 1 : 0}`);
        });
        return flags.join(" ");
      }

      function buildIni(selections, selectedProfile) {
        const flags = buildFlags(selections).replace(/ -D/g, "\n  -D");
        return `# Custom CrossPoint Reader Build Configuration\n# Generated by web configurator\n# Selected profile: ${selectedProfile}\n\n[env:custom]\nextends = base\nbuild_flags =\n  \\${base.build_flags}\n  -DCROSSPOINT_VERSION=\\\"\\${crosspoint.version}-custom\\\"\n  ${flags}\n`;
      }

      function buildGenerateCommand(selections, matchingProfile, baseProfileName) {
        if (matchingProfile) {
          return `uv run python scripts/generate_build_config.py --profile ${matchingProfile}`;
        }
        const baseSelections = profileToSelections(baseProfileName);
        const args = [
          "uv run python scripts/generate_build_config.py",
          `--profile ${baseProfileName}`,
        ];
        Object.keys(FEATURES).forEach((feature) => {
          if (selections[feature] !== baseSelections[feature]) {
            args.push(selections[feature] ? `--enable ${feature}` : `--disable ${feature}`);
          }
        });
        return args.join(" ");
      }

      function buildShareUrl(selections, selectedProfile) {
        const url = new URL(window.location.href);
        url.search = "";
        const shareProfile = selectedProfile === "custom" ? baseProfile : selectedProfile;
        url.searchParams.set("profile", shareProfile);
        Object.keys(FEATURES).forEach((feature) => {
          url.searchParams.set(feature, selections[feature] ? "1" : "0");
        });
        return url.toString();
      }

      function parseInitialStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const requestedProfile = params.get("profile");
        const initialProfile = PROFILES[requestedProfile] ? requestedProfile : "standard";
        const selections = profileToSelections(initialProfile);
        Object.keys(FEATURES).forEach((feature) => {
          const parsed = parseBooleanParam(params.get(feature));
          if (parsed !== null) selections[feature] = parsed;
        });
        applyDependencyRules(selections, null, null);
        return { initialProfile, selections };
      }

      function updateOutputs(selections, selectedProfile, matchingProfile) {
        document.getElementById("flags-output").value = buildFlags(selections);
        document.getElementById("command-output").value = buildGenerateCommand(selections, matchingProfile, baseProfile);
        document.getElementById("ini-output").value = buildIni(selections, selectedProfile);
        document.getElementById("share-output").value = buildShareUrl(selections, selectedProfile);
      }

      function updateBuildLink(selections, selectedProfile) {
        const repo = getRepoInfo();
        const workflow = "build-custom.yml";
        const params = new URLSearchParams();
        params.set("profile", selectedProfile);
        Object.keys(FEATURES).forEach((feature) => {
          params.set(feature, selections[feature] ? "true" : "false");
        });
        const url = `https://github.com/${repo.owner}/${repo.repo}/actions/workflows/${workflow}?${params.toString()}`;
        document.getElementById("build-link").href = url;
      }

      /* Skill tree visuals */

      function formatSize(sizeKb) {
        if (sizeKb === 0) return '';
        if (Math.abs(sizeKb) >= 1024) return `~${(sizeKb / 1024).toFixed(1)} MB`;
        return `~${sizeKb} KB`;
      }

      function updateSizeDisplay(size) {
        const percentage = (size / MAX_FLASH_MB) * 100;
        const sizeValue = document.getElementById("size-value");
        const sizeBar = document.getElementById("size-bar");
        const sizeContext = document.getElementById("size-context");

        sizeValue.textContent = `${size.toFixed(1)} MB`;
        sizeBar.style.width = `${Math.min(percentage, 100)}%`;

        if (size > MAX_FLASH_MB) {
          sizeContext.textContent = `${percentage.toFixed(0)}% \u2014 over capacity`;
          sizeValue.style.color = "#111";
          sizeBar.classList.add("over");
        } else {
          const remaining = MAX_FLASH_MB - size;
          sizeContext.textContent = `${percentage.toFixed(0)}% of 6.4 MB \u2014 ${remaining.toFixed(1)} MB free`;
          sizeValue.style.color = "var(--blk)";
          sizeBar.classList.remove("over");
        }
      }

      function isFeatureNode(nodeId) {
        return Object.prototype.hasOwnProperty.call(FEATURES, nodeId);
      }

      function isNoteNode(nodeId) {
        return Object.prototype.hasOwnProperty.call(NOTE_FEATURES, nodeId);
      }

      function isNoteActive(noteId, selections) {
        return (NOTE_FEATURES[noteId] || []).some((feature) => selections[feature]);
      }

      function isFeatureBlocked(feature, selections) {
        const parents = FEATURE_DEPENDENCIES[feature] || [];
        return parents.some((parent) => !selections[parent]);
      }

      function updateHubVisuals(selections) {
        document.querySelectorAll(".graph-hub[data-node-id]").forEach((hub) => {
          const hubId = hub.dataset.nodeId;
          const hasAnySelected = (HUB_FEATURES[hubId] || []).some((feature) => selections[feature]);
          hub.classList.toggle("active", hasAnySelected);
        });
      }

      function getNodeCenter(containerRect, nodeEl) {
        const centerTarget = nodeEl.querySelector(".node-ring") || nodeEl;
        const rect = centerTarget.getBoundingClientRect();
        return {
          x: rect.left - containerRect.left + rect.width / 2,
          y: rect.top - containerRect.top + rect.height / 2,
        };
      }

      function renderGraphEdges(selections) {
        const tree = document.getElementById("skill-tree");
        const svg = document.getElementById("graph-links");
        if (!tree || !svg) return;

        const width = tree.clientWidth;
        const height = tree.clientHeight;
        if (!width || !height) return;

        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.innerHTML = "";

        const treeRect = tree.getBoundingClientRect();
        const hubStates = {};
        Object.keys(HUB_FEATURES).forEach((hubId) => {
          hubStates[hubId] = HUB_FEATURES[hubId].some((feature) => selections[feature]);
        });

        GRAPH_EDGES.forEach((edge) => {
          const fromEl = tree.querySelector(`[data-node-id="${edge.from}"]`);
          const toEl = tree.querySelector(`[data-node-id="${edge.to}"]`);
          if (!fromEl || !toEl) return;

          const fromPoint = getNodeCenter(treeRect, fromEl);
          const toPoint = getNodeCenter(treeRect, toEl);
          const toIsFeature = isFeatureNode(edge.to);
          const toIsNote = isNoteNode(edge.to);
          const fromIsFeature = isFeatureNode(edge.from);

          let active = false;
          let locked = false;

          if (Object.prototype.hasOwnProperty.call(HUB_FEATURES, edge.to)) {
            active = hubStates[edge.to];
          } else if (toIsFeature) {
            active = selections[edge.to] && (!fromIsFeature || selections[edge.from]);
            locked = isFeatureBlocked(edge.to, selections);
          } else if (toIsNote) {
            active = isNoteActive(edge.to, selections) && (!fromIsFeature || selections[edge.from]);
          }

          if (locked) active = false;

          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute("x1", fromPoint.x.toFixed(2));
          line.setAttribute("y1", fromPoint.y.toFixed(2));
          line.setAttribute("x2", toPoint.x.toFixed(2));
          line.setAttribute("y2", toPoint.y.toFixed(2));
          line.classList.add("graph-edge");
          if (active) line.classList.add("active");
          if (locked) line.classList.add("locked");
          svg.appendChild(line);
        });
      }

      function updateSkillTreeVisuals(selections) {
        document.querySelectorAll(".skill-node[data-feature]").forEach((node) => {
          const feature = node.dataset.feature;
          const isEnabled = selections[feature];
          const isBlocked = isFeatureBlocked(feature, selections);
          const checkbox = node.querySelector("input");

          node.classList.toggle("active", isEnabled);
          node.classList.toggle("locked", isBlocked);
          checkbox.disabled = isBlocked;

          const sizeEl = node.querySelector(".tooltip-size");
          if (sizeEl) {
            const featureSize = formatSize(FEATURES[feature].sizeKb);
            sizeEl.textContent = featureSize ? `Flash: ${featureSize}` : "";
          }

          const nodeSizeEl = node.querySelector(".node-size");
          if (nodeSizeEl) {
            nodeSizeEl.textContent = formatSize(FEATURES[feature].sizeKb);
          }

          const iconEl = node.querySelector(".node-icon");
          if (isBlocked && iconEl) {
            iconEl.dataset.origIcon = iconEl.dataset.origIcon || iconEl.innerHTML;
            iconEl.innerHTML = "&#x25A0;";
          } else if (iconEl && iconEl.dataset.origIcon) {
            iconEl.innerHTML = iconEl.dataset.origIcon;
          }
        });

        updateHubVisuals(selections);
        document.querySelectorAll(".graph-note[data-node-id]").forEach((note) => {
          const noteId = note.dataset.nodeId;
          note.classList.toggle("active", isNoteActive(noteId, selections));
        });
        renderGraphEdges(selections);
      }

      function updateDependencyUi(selections) {
        updateSkillTreeVisuals(selections);
      }

      function updateAll(changedFeature = null, enabled = null) {
        const selections = readSelections();
        applyDependencyRules(selections, changedFeature, enabled);
        setSelections(selections);
        updateDependencyUi(selections);
        const matchingProfile = detectMatchingProfile(selections);
        highlightProfile(matchingProfile);
        updateProfileStatus(matchingProfile);
        const selectedProfile = matchingProfile || "custom";
        const size = computeSize(selections);
        updateSizeDisplay(size);
        updateOutputs(selections, selectedProfile, matchingProfile);
        updateBuildLink(selections, selectedProfile);
      }

      function flashCopyButton(btn) {
        btn.classList.add('copied');
        const orig = btn.textContent;
        btn.textContent = 'Copied';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.textContent = orig;
        }, 1200);
      }

      function setupEvents() {
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.addEventListener("click", () => applyProfile(btn.dataset.preset));
        });

        document.querySelectorAll("input[data-feature]").forEach((checkbox) => {
          checkbox.addEventListener("change", (event) => {
            const feature = event.target.dataset.feature;
            updateAll(feature, event.target.checked);
          });
        });

        const copyCommand = document.getElementById("copy-command");
        copyCommand.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("command-output").value);
          flashCopyButton(copyCommand);
        });

        const copyFlags = document.getElementById("copy-flags");
        copyFlags.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("flags-output").value);
          flashCopyButton(copyFlags);
        });

        const copyShare = document.getElementById("copy-share");
        copyShare.addEventListener("click", async () => {
          await navigator.clipboard.writeText(document.getElementById("share-output").value);
          flashCopyButton(copyShare);
        });

        document.getElementById("download-ini").addEventListener("click", () => {
          const content = document.getElementById("ini-output").value;
          const blob = new Blob([content], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "platformio-custom.ini";
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
        });

        let resizeFrame = null;
        window.addEventListener("resize", () => {
          if (resizeFrame !== null) cancelAnimationFrame(resizeFrame);
          resizeFrame = requestAnimationFrame(() => {
            resizeFrame = null;
            renderGraphEdges(readSelections());
          });
        });

        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(() => {
            renderGraphEdges(readSelections());
          });
        }
      }

      async function loadScreenPreviews() {
        const grid = document.getElementById("preview-grid");
        const meta = document.getElementById("preview-meta");
        const manifestUrl = "./screen-previews/manifest.json";

        try {
          const response = await fetch(manifestUrl, { cache: "no-store" });
          if (!response.ok) throw new Error(`manifest fetch failed (${response.status})`);
          const manifest = await response.json();

          const files = Array.isArray(manifest.files) ? manifest.files : [];
          if (files.length === 0) throw new Error("manifest is empty");

          const cards = files
            .map((file) => {
              const label = file.label || file.name || "Preview";
              const src = `./screen-previews/${file.name}`;
              return `<figure class="preview-card"><img src="${src}" alt="${label}" loading="lazy" /><figcaption>${label}</figcaption></figure>`;
            })
            .join("");

          grid.innerHTML = cards;
          const generatedAt = manifest.generated_at
            ? `Updated ${new Date(manifest.generated_at).toLocaleString()}`
            : "Updated recently";
          meta.textContent = generatedAt;
        } catch (error) {
          grid.innerHTML = '<div class="note-bar">Preview images are publishing. Check back in a minute.</div>';
          meta.textContent = "";
        }
      }

      setupEvents();
      const initialState = parseInitialStateFromUrl();
      baseProfile = initialState.initialProfile;
      setSelections(initialState.selections);
      highlightProfile(baseProfile);
      updateAll();
      loadScreenPreviews();
    </script>
  </body>
</html>
