name: Update Screen Previews

on:
  push:
    branches:
      - fork-drift
    paths-ignore:
      - "docs/configurator/screen-previews/**"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: update-screen-previews-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-previews:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install image tooling
        run: python -m pip install --upgrade pip pillow

      - name: Generate PBM snapshots
        run: tools/screen-harness/render_screens.sh build/screen-previews

      - name: Convert PBM to PNG
        run: tools/screen-harness/pbm_to_png.py build/screen-previews docs/configurator/screen-previews

      - name: Write preview manifest
        run: |
          python - <<'PY'
          import json
          from datetime import datetime, timezone
          from pathlib import Path

          out_dir = Path("docs/configurator/screen-previews")
          out_dir.mkdir(parents=True, exist_ok=True)

          labels = {
              "01_boot": "Boot",
              "02_home_mock": "Home",
              "03_settings_mock": "Settings",
              "04_factory_reset_mock": "Factory Reset",
              "05_reader_mock": "Reader",
          }

          files = []
          for png in sorted(out_dir.glob("*.png")):
              stem = png.stem
              files.append({
                  "name": png.name,
                  "label": labels.get(stem, stem.replace("_", " ").title()),
              })

          manifest = {
              "generated_at": datetime.now(timezone.utc).isoformat(),
              "files": files,
          }

          (out_dir / "manifest.json").write_text(json.dumps(manifest, indent=2) + "\n", encoding="utf-8")
          PY

      - name: Commit updated previews
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update feature picker screen previews [skip ci]"
          file_pattern: docs/configurator/screen-previews/*
