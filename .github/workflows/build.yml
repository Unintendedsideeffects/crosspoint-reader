name: Build

on:
  push:
    branches: ['**']
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

jobs:
  # ── Gate: validation checks run once before any builds ──────────
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen

      - name: Ensure pip for PlatformIO
        run: |
          uv run python -m ensurepip --upgrade || true
          uv run python -m pip --version

      - name: Validate feature key synchronization
        run: uv run python scripts/check_feature_key_sync.py

      - name: Validate generated platformio-custom.ini is up to date
        run: |
          uv run python scripts/generate_build_config.py --profile standard
          git diff --exit-code -- platformio-custom.ini

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('platformio.ini') }}
          restore-keys: ${{ runner.os }}-platformio-

      - name: Static checks (cppcheck)
        run: uv run pio check -e default

      - name: Run host tests
        run: bash test/run_host_tests.sh

  # ── Build: 3 profiles in parallel ──────────────────────────────
  build:
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - profile: lean
            version_suffix: "-lean"
          - profile: standard
            version_suffix: ""
          - profile: full
            version_suffix: "-full"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen

      - name: Ensure pip for PlatformIO
        run: |
          uv run python -m ensurepip --upgrade || true
          uv run python -m pip --version

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('platformio.ini') }}
          restore-keys: ${{ runner.os }}-platformio-

      - name: Generate build configuration
        run: |
          uv run python scripts/generate_build_config.py --profile "${{ matrix.profile }}"
          cat platformio-custom.ini

      - name: Patch version string
        run: |
          sed -i 's/-custom\\"/${{ matrix.version_suffix }}\\"/g' platformio-custom.ini
          grep CROSSPOINT_VERSION platformio-custom.ini

      - name: Build firmware
        run: uv run pio run -e custom | tee pio.log

      - name: Enforce flash headroom
        run: |
          uv run python scripts/check_flash_headroom.py \
            --log pio.log \
            --firmware .pio/build/custom/firmware.bin \
            --min-headroom-kb 64

      - name: Report firmware size
        run: |
          echo "### Firmware Size (${{ matrix.profile }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh .pio/build/custom/firmware.bin >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Flash headroom threshold: 64 KiB" >> $GITHUB_STEP_SUMMARY

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp .pio/build/custom/firmware.bin artifact/
          cp .pio/build/custom/partitions.bin artifact/

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.profile }}
          path: artifact/
          retention-days: 30

  # ── Build (latest channel): gh_latest env, fork-drift only ─────
  build-latest:
    needs: validate
    if: >-
      !startsWith(github.ref, 'refs/tags/')
      && github.ref == 'refs/heads/fork-drift'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0  # full history needed for accurate commit count

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen

      - name: Ensure pip for PlatformIO
        run: |
          uv run python -m ensurepip --upgrade || true
          uv run python -m pip --version

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('platformio.ini') }}
          restore-keys: ${{ runner.os }}-platformio-

      - name: Compute commit count and version
        id: ver
        run: |
          COUNT=$(git rev-list --count HEAD)
          COUNT=$((COUNT > 99999 ? 99999 : COUNT))
          echo "version=${COUNT}-dev" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT_COUNT=${COUNT}" >> $GITHUB_ENV

      - name: Build firmware (gh_latest)
        run: uv run pio run -e gh_latest | tee pio.log

      - name: Enforce flash headroom
        run: |
          uv run python scripts/check_flash_headroom.py \
            --log pio.log \
            --firmware .pio/build/gh_latest/firmware.bin \
            --min-headroom-kb 64

      - name: Upload latest firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-latest
          path: |
            .pio/build/gh_latest/firmware.bin
            .pio/build/gh_latest/partitions.bin
          retention-days: 7

  # ── Publish: update rolling latest channel (4 variants) on fork-drift push ─
  publish-latest:
    needs: [build, build-latest]
    if: >-
      !startsWith(github.ref, 'refs/tags/')
      && github.ref == 'refs/heads/fork-drift'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download latest standard firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-latest
          path: artifacts/latest-standard

      - name: Download lean firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-lean
          path: artifacts/lean

      - name: Download full firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-full
          path: artifacts/full

      - name: Prepare latest channel assets
        run: |
          set -euo pipefail
          mkdir -p channel
          cp artifacts/latest-standard/firmware.bin channel/crosspoint-standard.bin
          cp artifacts/latest-standard/partitions.bin channel/crosspoint-standard-partitions.bin
          cp artifacts/lean/firmware.bin channel/crosspoint-lean.bin
          cp artifacts/lean/partitions.bin channel/crosspoint-lean-partitions.bin
          cp artifacts/full/firmware.bin channel/crosspoint-full.bin
          cp artifacts/full/partitions.bin channel/crosspoint-full-partitions.bin
          # lean-reset intentionally reuses the lean profile firmware.
          cp artifacts/lean/firmware.bin channel/crosspoint-lean-reset.bin
          cp artifacts/lean/partitions.bin channel/crosspoint-lean-reset-partitions.bin
          ls -lh channel

      - name: Remove existing latest assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          asset_ids="$(gh api repos/${{ github.repository }}/releases/tags/latest \
            --jq '.assets[] | .id' \
            2>/dev/null || true)"
          if [ -z "$asset_ids" ]; then
            echo "No existing latest assets to remove."
            exit 0
          fi
          for asset_id in $asset_ids; do
            gh api -X DELETE "repos/${{ github.repository }}/releases/assets/${asset_id}" || true
          done

      - name: Publish latest channel release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ${{ needs.build-latest.outputs.version }}
          prerelease: true
          draft: false
          generate_release_notes: false
          files: channel/*.bin

  # ── Release: versioned release + rolling channel on tag push ────
  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        id: version
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          VER="${TAG#v}"  # strip leading 'v' for the rolling release channel name
          echo "ver=${VER}" >> $GITHUB_OUTPUT

          # Standard firmware (default names)
          cp artifacts/firmware-standard/firmware.bin firmware.bin
          cp artifacts/firmware-standard/partitions.bin partitions.bin
          cp firmware.bin "crosspoint-${TAG}.bin"
          cp partitions.bin "crosspoint-${TAG}-partitions.bin"

          # Lean firmware
          cp artifacts/firmware-lean/firmware.bin firmware-lean.bin
          cp artifacts/firmware-lean/partitions.bin partitions-lean.bin
          cp firmware-lean.bin "crosspoint-${TAG}-lean.bin"
          cp partitions-lean.bin "crosspoint-${TAG}-lean-partitions.bin"

          # Lean reset firmware (same payload as lean, separate distribution target)
          cp firmware-lean.bin firmware-lean-reset.bin
          cp partitions-lean.bin partitions-lean-reset.bin
          cp firmware-lean-reset.bin "crosspoint-${TAG}-lean-reset.bin"
          cp partitions-lean-reset.bin "crosspoint-${TAG}-lean-reset-partitions.bin"

          # Full firmware
          cp artifacts/firmware-full/firmware.bin firmware-full.bin
          cp artifacts/firmware-full/partitions.bin partitions-full.bin
          cp firmware-full.bin "crosspoint-${TAG}-full.bin"
          cp partitions-full.bin "crosspoint-${TAG}-full-partitions.bin"

          # Stable channel rolling assets (tag: stable)
          cp firmware.bin crosspoint-standard.bin
          cp partitions.bin crosspoint-standard-partitions.bin
          cp firmware-lean.bin crosspoint-lean.bin
          cp partitions-lean.bin crosspoint-lean-partitions.bin
          cp firmware-full.bin crosspoint-full.bin
          cp partitions-full.bin crosspoint-full-partitions.bin
          cp firmware-lean-reset.bin crosspoint-lean-reset.bin
          cp partitions-lean-reset.bin crosspoint-lean-reset-partitions.bin

          echo "Release assets:"
          ls -lh *.bin

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            firmware.bin
            partitions.bin
            firmware-lean.bin
            partitions-lean.bin
            firmware-full.bin
            partitions-full.bin
            firmware-lean-reset.bin
            partitions-lean-reset.bin
            crosspoint-${{ github.ref_name }}.bin
            crosspoint-${{ github.ref_name }}-partitions.bin
            crosspoint-${{ github.ref_name }}-lean.bin
            crosspoint-${{ github.ref_name }}-lean-partitions.bin
            crosspoint-${{ github.ref_name }}-full.bin
            crosspoint-${{ github.ref_name }}-full-partitions.bin
            crosspoint-${{ github.ref_name }}-lean-reset.bin
            crosspoint-${{ github.ref_name }}-lean-reset-partitions.bin
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

      - name: Remove existing stable channel assets
        if: ${{ !contains(github.ref_name, '-') }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          asset_ids="$(gh api repos/${{ github.repository }}/releases/tags/stable \
            --jq '.assets[] | .id' \
            2>/dev/null || true)"
          if [ -z "$asset_ids" ]; then
            echo "No existing stable channel assets to remove."
            exit 0
          fi
          for asset_id in $asset_ids; do
            gh api -X DELETE "repos/${{ github.repository }}/releases/assets/${asset_id}" || true
          done

      - name: Publish stable channel
        if: ${{ !contains(github.ref_name, '-') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: stable
          name: ${{ steps.version.outputs.ver }}
          prerelease: false
          draft: false
          generate_release_notes: false
          files: |
            crosspoint-standard.bin
            crosspoint-standard-partitions.bin
            crosspoint-lean.bin
            crosspoint-lean-partitions.bin
            crosspoint-full.bin
            crosspoint-full-partitions.bin
            crosspoint-lean-reset.bin
            crosspoint-lean-reset-partitions.bin
