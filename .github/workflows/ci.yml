name: CI (build)

on:
  push:
    branches: [master]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  clang-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run clang-format
        run: |
          uv run ./bin/clang-format-fix
          git diff --exit-code || (echo "Please run 'bin/clang-format-fix' to fix formatting issues" && exit 1)

  feature-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Validate feature key synchronization
        run: uv run python scripts/check_feature_key_sync.py

      - name: Validate generated platformio-custom.ini is up to date
        run: |
          uv run python scripts/generate_build_config.py --profile standard
          git diff --exit-code -- platformio-custom.ini

  host-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install PlatformIO Core
        run: python -m pip install -U https://github.com/pioarduino/platformio-core/archive/refs/tags/v6.1.19.zip

      - name: Run host tests
        run: bash test/run_host_tests.sh

  contract-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Start contract server
        run: |
          python3 scripts/contract_server.py --port 8765 &
          for i in $(seq 1 20); do
            if curl -sf http://127.0.0.1:8765/_test/ping > /dev/null; then break; fi
            sleep 1
          done

      - name: Verify endpoint shapes
        run: |
          set -euo pipefail

          BASE="http://127.0.0.1:8765"

          check() {
            local desc="$1" url="$2" expected="$3"
            local body; body=$(curl -sf "$url")
            if echo "$body" | grep -qF "$expected"; then
              echo "PASS: $desc"
            else
              echo "FAIL: $desc — expected '$expected' in: $body"
              exit 1
            fi
          }

          # Reset to clean state
          curl -sf -X POST "$BASE/_test/reset"

          # /api/status returns required fields
          check "status has version"   "$BASE/api/status"  '"version"'
          check "status has wifiStatus" "$BASE/api/status" '"wifiStatus"'
          check "status has ip"        "$BASE/api/status"  '"ip"'

          # /api/plugins returns snake_case flags
          check "plugins has ota_updates"    "$BASE/api/plugins" '"ota_updates"'
          check "plugins has user_fonts"     "$BASE/api/plugins" '"user_fonts"'
          check "plugins has web_wifi_setup" "$BASE/api/plugins" '"web_wifi_setup"'

          # /api/sleep-images returns empty array by default
          check "sleep-images empty" "$BASE/api/sleep-images" "[]"

          # /api/sleep-cover returns {path, name} shape
          check "sleep-cover has path" "$BASE/api/sleep-cover" '"path"'
          check "sleep-cover has name" "$BASE/api/sleep-cover" '"name"'

          # Seed sleep images and re-check
          curl -sf -X POST -H "Content-Type: application/json" \
            -d '{"sleepImages":[{"path":"/sleep/a.bmp","name":"a.bmp"}]}' \
            "$BASE/_test/seed"
          check "sleep-images has entry" "$BASE/api/sleep-images" '"path":"/sleep/a.bmp"'

          # Pin Mode A: path → firmware returns {"pinnedPath":"..."}
          curl -sf -X POST -H "Content-Type: application/json" \
            -d '{"path":"/sleep/a.bmp"}' "$BASE/api/sleep-cover/pin" | grep -q '"pinnedPath"'
          echo "PASS: pin Mode A returns pinnedPath JSON"

          # Pin Mode A: clear → firmware returns plain text "Cleared"
          clear_resp=$(curl -sf -X POST -H "Content-Type: application/json" \
            -d '{"path":""}' "$BASE/api/sleep-cover/pin")
          if [ "$clear_resp" = "Cleared" ]; then
            echo "PASS: pin clear returns Cleared"
          else
            echo "FAIL: pin clear returned: $clear_resp"
            exit 1
          fi

          # Pin Mode B: bookPath → firmware returns {"pinnedPath":"..."}
          curl -sf -X POST -H "Content-Type: application/json" \
            -d '{"bookPath":"/books/dune.epub"}' "$BASE/api/sleep-cover/pin" | grep -q '"pinnedPath"'
          echo "PASS: pin Mode B returns pinnedPath JSON"

          # Mutations endpoint returns expected keys
          check "mutations has pinRequests" "$BASE/_test/mutations" '"pinRequests"'

          echo "All contract server checks passed."

  hardware-patterns:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Check hardware coding patterns
        run: python3 scripts/check_hardware_patterns.py

  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install PlatformIO Core
        run: python -m pip install -U https://github.com/pioarduino/platformio-core/archive/refs/tags/v6.1.19.zip

      - name: Run cppcheck
        run: pio check --fail-on-defect low --fail-on-defect medium --fail-on-defect high

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install PlatformIO Core
        run: python -m pip install -U https://github.com/pioarduino/platformio-core/archive/refs/tags/v6.1.19.zip

      - name: Build CrossPoint
        run: |
          set -euo pipefail
          pio run | tee pio.log

      - name: Enforce flash headroom
        run: |
          python scripts/check_flash_headroom.py \
            --log pio.log \
            --firmware .pio/build/default/firmware.bin \
            --min-headroom-kb 64

      - name: Extract firmware stats

        run: |
          set -euo pipefail
          ram_line="$(grep -E "RAM:\\s" -m1 pio.log || true)"
          flash_line="$(grep -E "Flash:\\s" -m1 pio.log || true)"
          echo "ram_line=${ram_line}" >> "$GITHUB_OUTPUT"
          echo "flash_line=${flash_line}" >> "$GITHUB_OUTPUT"
          {
            echo "## Firmware build stats"
            if [ -n "$ram_line" ]; then echo "- ${ram_line}"; else echo "- RAM: not found"; fi
            if [ -n "$flash_line" ]; then echo "- ${flash_line}"; else echo "- Flash: not found"; fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload firmware.bin artifact
        uses: actions/upload-artifact@v6
        with:
          name: firmware.bin
          path: .pio/build/default/firmware.bin
          if-no-files-found: error

  # This job is used as the PR required actions check, allows for changes to other steps in the future without breaking
  # PR requirements.
  test-status:
    name: Test Status
    needs:
      - build
      - clang-format
      - feature-sync
      - host-tests
      - contract-server
      - hardware-patterns
      - cppcheck
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Fail because needed jobs failed
        # Fail if any job failed or was cancelled (skipped jobs are ok)
        if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}
        run: exit 1
      - name: Success
        run: exit 0
