name: Build Custom Firmware

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Base build profile'
        required: true
        type: choice
        default: 'standard'
        options:
          - lean
          - standard
          - full
          - custom
      extended_fonts:
        description: 'Extended Fonts (12/16/18pt, ~2.5MB)'
        required: false
        type: boolean
        default: true
      opendyslexic_fonts:
        description: 'OpenDyslexic Fonts (~1.0MB, requires Extended Fonts)'
        required: false
        type: boolean
        default: false
      image_sleep:
        description: 'PNG/JPEG/BMP Sleep Images (~0KB base)'
        required: false
        type: boolean
        default: true
      markdown:
        description: 'Markdown Support (~231KB)'
        required: false
        type: boolean
        default: true
      integrations:
        description: 'Integrations base layer (~0KB)'
        required: false
        type: boolean
        default: false
      koreader_sync:
        description: 'KOReader Sync (~142KB)'
        required: false
        type: boolean
        default: false
      calibre_sync:
        description: 'Calibre Sync (~223KB)'
        required: false
        type: boolean
        default: false
      background_server:
        description: 'Background Web Server (~0KB base)'
        required: false
        type: boolean
        default: true
      home_media_picker:
        description: 'Home Media Picker UI (~-4KB)'
        required: false
        type: boolean
        default: true
      web_pokedex_plugin:
        description: 'Web Pokedex Plugin (~-4KB)'
        required: false
        type: boolean
        default: false
      epub_support:
        description: 'EPUB Support (~157KB)'
        required: false
        type: boolean
        default: true
      hyphenation:
        description: 'EPUB Hyphenation (~447KB)'
        required: false
        type: boolean
        default: true
      xtc_support:
        description: 'XTC support (~13KB)'
        required: false
        type: boolean
        default: true
      lyra_theme:
        description: 'Lyra theme (~5KB)'
        required: false
        type: boolean
        default: true
      ota_updates:
        description: 'OTA Updates (~230KB)'
        required: false
        type: boolean
        default: true
      todo_planner:
        description: 'Todo/Planner (~237KB)'
        required: false
        type: boolean
        default: false
      dark_mode:
        description: 'Dark Mode (~0KB base)'
        required: false
        type: boolean
        default: true
      visual_cover_picker:
        description: 'Visual Cover Picker (~118KB)'
        required: false
        type: boolean
        default: false
      ble_wifi_provisioning:
        description: 'BLE WiFi Provisioning (~619KB)'
        required: false
        type: boolean
        default: false
      user_fonts:
        description: 'User Fonts from SD (~4KB)'
        required: false
        type: boolean
        default: true
      web_wifi_setup:
        description: 'Web WiFi Setup (~4KB)'
        required: false
        type: boolean
        default: true
      usb_mass_storage:
        description: 'USB Mass Storage prompt mode (~8KB)'
        required: false
        type: boolean
        default: true

jobs:
  build-custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen

      - name: Ensure pip for PlatformIO
        run: |
          uv run python -m ensurepip --upgrade || true
          uv run python -m pip --version

      - name: Generate custom build configuration
        id: config
        run: |
          CMD=(uv run python scripts/generate_build_config.py)
          
          # Add base profile if selected
          if [ "${{ inputs.profile }}" != "custom" ]; then
            echo "Using base profile: ${{ inputs.profile }}"
            CMD+=(--profile "${{ inputs.profile }}")
          fi

          # Apply individual feature toggles as overrides
          # This ensures toggles are respected even if a profile is selected
          
          # Boolean inputs from GitHub Actions are strings "true" or "false"
          [ "${{ inputs.extended_fonts }}" == "true" ] && CMD+=(--enable extended_fonts) || CMD+=(--disable extended_fonts)
          [ "${{ inputs.opendyslexic_fonts }}" == "true" ] && CMD+=(--enable opendyslexic_fonts) || CMD+=(--disable opendyslexic_fonts)
          [ "${{ inputs.image_sleep }}" == "true" ] && CMD+=(--enable image_sleep) || CMD+=(--disable image_sleep)
          [ "${{ inputs.markdown }}" == "true" ] && CMD+=(--enable markdown) || CMD+=(--disable markdown)
          [ "${{ inputs.integrations }}" == "true" ] && CMD+=(--enable integrations) || CMD+=(--disable integrations)
          [ "${{ inputs.koreader_sync }}" == "true" ] && CMD+=(--enable koreader_sync) || CMD+=(--disable koreader_sync)
          [ "${{ inputs.calibre_sync }}" == "true" ] && CMD+=(--enable calibre_sync) || CMD+=(--disable calibre_sync)
          [ "${{ inputs.background_server }}" == "true" ] && CMD+=(--enable background_server) || CMD+=(--disable background_server)
          [ "${{ inputs.home_media_picker }}" == "true" ] && CMD+=(--enable home_media_picker) || CMD+=(--disable home_media_picker)
          [ "${{ inputs.web_pokedex_plugin }}" == "true" ] && CMD+=(--enable web_pokedex_plugin) || CMD+=(--disable web_pokedex_plugin)
          [ "${{ inputs.epub_support }}" == "true" ] && CMD+=(--enable epub_support) || CMD+=(--disable epub_support)
          [ "${{ inputs.hyphenation }}" == "true" ] && CMD+=(--enable hyphenation) || CMD+=(--disable hyphenation)
          [ "${{ inputs.xtc_support }}" == "true" ] && CMD+=(--enable xtc_support) || CMD+=(--disable xtc_support)
          [ "${{ inputs.lyra_theme }}" == "true" ] && CMD+=(--enable lyra_theme) || CMD+=(--disable lyra_theme)
          [ "${{ inputs.ota_updates }}" == "true" ] && CMD+=(--enable ota_updates) || CMD+=(--disable ota_updates)
          [ "${{ inputs.todo_planner }}" == "true" ] && CMD+=(--enable todo_planner) || CMD+=(--disable todo_planner)
          [ "${{ inputs.dark_mode }}" == "true" ] && CMD+=(--enable dark_mode) || CMD+=(--disable dark_mode)
          [ "${{ inputs.visual_cover_picker }}" == "true" ] && CMD+=(--enable visual_cover_picker) || CMD+=(--disable visual_cover_picker)
          [ "${{ inputs.ble_wifi_provisioning }}" == "true" ] && CMD+=(--enable ble_wifi_provisioning) || CMD+=(--disable ble_wifi_provisioning)
          [ "${{ inputs.user_fonts }}" == "true" ] && CMD+=(--enable user_fonts) || CMD+=(--disable user_fonts)
          [ "${{ inputs.web_wifi_setup }}" == "true" ] && CMD+=(--enable web_wifi_setup) || CMD+=(--disable web_wifi_setup)
          [ "${{ inputs.usb_mass_storage }}" == "true" ] && CMD+=(--enable usb_mass_storage) || CMD+=(--disable usb_mass_storage)

          echo "Executing: ${CMD[@]}"
          "${CMD[@]}"

          # Show generated configuration
          echo "### Generated configuration:"
          cat platformio-custom.ini

      - name: Compute build identity
        id: identity
        env:
          PROFILE_INPUT: ${{ inputs.profile }}
        run: |
          FEATURE_FLAGS=$(
          python - <<'PY'
          import re
          from pathlib import Path

          lines = Path("platformio-custom.ini").read_text().splitlines()
          flags = {}
          for line in lines:
              match = re.search(r"-D([A-Z0-9_]+)=(0|1)\b", line)
              if not match:
                  continue
              macro = match.group(1)
              value = match.group(2)
              if macro.startswith("ENABLE_"):
                  flags[macro] = value

          if not flags:
              raise SystemExit("No ENABLE_* flags found in platformio-custom.ini")

          print(";".join(f"{macro}={flags[macro]}" for macro in sorted(flags)))
          PY
          )
          FEATURESET_STRING="profile=${PROFILE_INPUT};${FEATURE_FLAGS}"
          FEATURESET_HASH=$(printf "%s|%s" "$GITHUB_SHA" "$FEATURESET_STRING" | sha256sum | cut -c1-16)
          ARTIFACT_NAME="custom-firmware-${GITHUB_SHA:0:7}-${FEATURESET_HASH}"

          echo "featureset_string=$FEATURESET_STRING" >> "$GITHUB_OUTPUT"
          echo "featureset_hash=$FEATURESET_HASH" >> "$GITHUB_OUTPUT"
          echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"

          echo "Feature-set key: $FEATURESET_HASH"
          echo "Artifact name: $ARTIFACT_NAME"

      - name: Check for reusable artifact
        id: reuse
        env:
          GH_TOKEN: ${{ github.token }}
          ARTIFACT_NAME: ${{ steps.identity.outputs.artifact_name }}
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.parse
          import urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GH_TOKEN"]
          artifact_name = os.environ["ARTIFACT_NAME"]
          current_run_id = int(os.environ["GITHUB_RUN_ID"])
          sha = os.environ["GITHUB_SHA"]
          output_path = os.environ["GITHUB_OUTPUT"]

          url = (
              f"https://api.github.com/repos/{repo}/actions/artifacts"
              f"?name={urllib.parse.quote(artifact_name)}&per_page=100"
          )
          request = urllib.request.Request(
              url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "X-GitHub-Api-Version": "2022-11-28",
              },
          )

          with urllib.request.urlopen(request) as response:
              payload = json.load(response)

          candidates = []
          for artifact in payload.get("artifacts", []):
              if artifact.get("expired"):
                  continue
              run = artifact.get("workflow_run") or {}
              run_id = int(run.get("id", 0))
              if run_id == current_run_id:
                  continue
              if run.get("head_sha") != sha:
                  continue
              candidates.append(artifact)

          selected = max(candidates, key=lambda item: item.get("id", 0), default=None)

          with open(output_path, "a", encoding="utf-8") as out:
              if selected is None:
                  out.write("found=false\n")
                  print("No reusable artifact found for this commit and feature set.")
              else:
                  run = selected.get("workflow_run") or {}
                  out.write("found=true\n")
                  out.write(f"artifact_id={selected['id']}\n")
                  out.write(f"archive_url={selected['archive_download_url']}\n")
                  out.write(f"source_run_id={run.get('id', '')}\n")
                  print(
                      f"Reusing artifact id={selected['id']} "
                      f"from run={run.get('id', 'unknown')}"
                  )
          PY

      - name: Reuse existing artifact payload
        if: steps.reuse.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ARCHIVE_URL: ${{ steps.reuse.outputs.archive_url }}
        run: |
          python - <<'PY'
          import io
          import os
          import shutil
          import urllib.request
          import zipfile
          from pathlib import Path

          archive_url = os.environ["ARCHIVE_URL"]
          token = os.environ["GH_TOKEN"]
          request = urllib.request.Request(
              archive_url,
              headers={
                  "Authorization": f"Bearer {token}",
                  "Accept": "application/vnd.github+json",
                  "X-GitHub-Api-Version": "2022-11-28",
              },
          )

          with urllib.request.urlopen(request) as response:
              zip_bytes = response.read()

          extract_root = Path("dist/reused-artifact")
          package_root = Path("dist/custom-firmware-package")
          if extract_root.exists():
              shutil.rmtree(extract_root)
          if package_root.exists():
              shutil.rmtree(package_root)
          extract_root.mkdir(parents=True, exist_ok=True)
          package_root.mkdir(parents=True, exist_ok=True)

          with zipfile.ZipFile(io.BytesIO(zip_bytes)) as archive:
              archive.extractall(extract_root)

          def first_match(filename: str) -> Path:
              matches = sorted(
                  (path for path in extract_root.rglob(filename) if path.is_file()),
                  key=lambda path: len(path.parts),
              )
              if not matches:
                  raise SystemExit(f"Required file '{filename}' not found in reusable artifact")
              return matches[0]

          shutil.copy2(first_match("firmware.bin"), package_root / "firmware.bin")
          shutil.copy2(first_match("partitions.bin"), package_root / "partitions.bin")
          shutil.copy2(first_match("platformio-custom.ini"), package_root / "platformio-custom.ini")
          print("Reused artifact payload extracted to dist/custom-firmware-package")
          PY

      - name: Build custom firmware
        if: steps.reuse.outputs.found != 'true'
        run: uv run pio run -e custom | tee pio-custom.log

      - name: Enforce flash headroom
        if: steps.reuse.outputs.found != 'true'
        run: |
          uv run python scripts/check_flash_headroom.py \
            --log pio-custom.log \
            --firmware .pio/build/custom/firmware.bin \
            --min-headroom-kb 64

      - name: Assemble root-level firmware package
        env:
          REUSED: ${{ steps.reuse.outputs.found }}
          SOURCE_RUN: ${{ steps.reuse.outputs.source_run_id }}
          SOURCE_ARTIFACT_ID: ${{ steps.reuse.outputs.artifact_id }}
          FEATURESET_STRING: ${{ steps.identity.outputs.featureset_string }}
          FEATURESET_HASH: ${{ steps.identity.outputs.featureset_hash }}
          ARTIFACT_NAME: ${{ steps.identity.outputs.artifact_name }}
          PROFILE_INPUT: ${{ inputs.profile }}
        run: |
          mkdir -p dist/custom-firmware-package

          if [ "${REUSED}" != "true" ]; then
            cp .pio/build/custom/firmware.bin dist/custom-firmware-package/firmware.bin
            cp .pio/build/custom/partitions.bin dist/custom-firmware-package/partitions.bin
            cp platformio-custom.ini dist/custom-firmware-package/platformio-custom.ini
          fi

          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone
          from pathlib import Path

          package = Path("dist/custom-firmware-package")
          required = [
              package / "firmware.bin",
              package / "partitions.bin",
              package / "platformio-custom.ini",
          ]
          missing = [str(path) for path in required if not path.exists()]
          if missing:
              raise SystemExit(f"Package assembly failed; missing files: {missing}")

          metadata = {
              "artifact_name": os.environ["ARTIFACT_NAME"],
              "commit_sha": os.environ["GITHUB_SHA"],
              "workflow_run_id": os.environ["GITHUB_RUN_ID"],
              "profile_input": os.environ["PROFILE_INPUT"],
              "featureset_string": os.environ["FEATURESET_STRING"],
              "featureset_hash": os.environ["FEATURESET_HASH"],
              "reused_existing_build": os.environ["REUSED"] == "true",
              "source_run_id": os.environ.get("SOURCE_RUN") or None,
              "source_artifact_id": os.environ.get("SOURCE_ARTIFACT_ID") or None,
              "generated_at_utc": datetime.now(timezone.utc).isoformat(),
          }
          (package / "build-metadata.json").write_text(json.dumps(metadata, indent=2) + "\n")
          PY

      - name: Report firmware size
        env:
          REUSED: ${{ steps.reuse.outputs.found }}
        run: |
          FIRMWARE_PATH="dist/custom-firmware-package/firmware.bin"
          CONFIG_PATH="dist/custom-firmware-package/platformio-custom.ini"

          echo "### Custom Firmware Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Base Profile:** ${{ inputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** ${{ steps.identity.outputs.artifact_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Feature-set Hash:** \`${{ steps.identity.outputs.featureset_hash }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${REUSED}" == "true" ]; then
            echo "**Build Source:** Reused existing artifact from run #${{ steps.reuse.outputs.source_run_id }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Build Source:** Built in this run" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Feature Toggles:**" >> $GITHUB_STEP_SUMMARY
          echo "- Extended Fonts: ${{ inputs.extended_fonts }}" >> $GITHUB_STEP_SUMMARY
          echo "- OpenDyslexic: ${{ inputs.opendyslexic_fonts }}" >> $GITHUB_STEP_SUMMARY
          echo "- PNG/JPEG/BMP Sleep: ${{ inputs.image_sleep }}" >> $GITHUB_STEP_SUMMARY
          echo "- Markdown: ${{ inputs.markdown }}" >> $GITHUB_STEP_SUMMARY
          # ... simplified for summary ...
          echo "- EPUB Support: ${{ inputs.epub_support }}" >> $GITHUB_STEP_SUMMARY
          echo "- Visual Cov Picker: ${{ inputs.visual_cover_picker }}" >> $GITHUB_STEP_SUMMARY
          echo "- BLE WiFi: ${{ inputs.ble_wifi_provisioning }}" >> $GITHUB_STEP_SUMMARY
          echo "- User Fonts: ${{ inputs.user_fonts }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web WiFi Setup: ${{ inputs.web_wifi_setup }}" >> $GITHUB_STEP_SUMMARY
          echo "- USB Mass Storage: ${{ inputs.usb_mass_storage }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Firmware Size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f "${FIRMWARE_PATH}" ]; then
            SIZE=$(stat -c%s "${FIRMWARE_PATH}")
            SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
            ls -lh "${FIRMWARE_PATH}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Firmware size: ${SIZE_MB}MB / 6.4MB available" >> $GITHUB_STEP_SUMMARY

            # Calculate percentage
            PERCENT=$(echo "scale=1; $SIZE_MB * 100 / 6.4" | bc)
            echo "Flash usage: ${PERCENT}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "ERROR: No firmware.bin found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo '```ini' >> $GITHUB_STEP_SUMMARY
          cat "${CONFIG_PATH}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload custom firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.identity.outputs.artifact_name }}
          path: dist/custom-firmware-package/*
          retention-days: 30

      - name: Build summary
        run: |
          echo "âœ… Custom firmware build complete!"
          echo ""
          echo "Download artifact '${{ steps.identity.outputs.artifact_name }}' from the Actions tab."
          echo "Flash using: esptool.py write_flash 0x10000 firmware.bin"
