name: Build Custom Firmware

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        type: choice
        default: 'standard'
        options:
          - lean
          - standard
          - full
          - custom
      extended_fonts:
        description: 'Extended Fonts (12/16/18pt, ~2.5MB)'
        required: false
        type: boolean
        default: true
      opendyslexic_fonts:
        description: 'OpenDyslexic Fonts (~3.6MB)'
        required: false
        type: boolean
        default: false
      image_sleep:
        description: 'PNG/JPEG/BMP Sleep Images (~0KB base)'
        required: false
        type: boolean
        default: true
      markdown:
        description: 'Markdown Support (~231KB)'
        required: false
        type: boolean
        default: true
      integrations:
        description: 'Integrations base layer (~0KB)'
        required: false
        type: boolean
        default: false
      koreader_sync:
        description: 'KOReader Sync (~142KB)'
        required: false
        type: boolean
        default: false
      calibre_sync:
        description: 'Calibre Sync (~223KB)'
        required: false
        type: boolean
        default: false
      background_server:
        description: 'Background Web Server (~0KB base)'
        required: false
        type: boolean
        default: true
      home_media_picker:
        description: 'Home Media Picker UI (~-4KB)'
        required: false
        type: boolean
        default: true
      web_pokedex_plugin:
        description: 'Web Pokedex Plugin (~-4KB)'
        required: false
        type: boolean
        default: false
      epub_support:
        description: 'EPUB Support (~157KB)'
        required: false
        type: boolean
        default: true
      hyphenation:
        description: 'EPUB Hyphenation (~447KB)'
        required: false
        type: boolean
        default: true
      xtc_support:
        description: 'XTC support (~13KB)'
        required: false
        type: boolean
        default: true
      lyra_theme:
        description: 'Lyra theme (~5KB)'
        required: false
        type: boolean
        default: true
      ota_updates:
        description: 'OTA Updates (~230KB)'
        required: false
        type: boolean
        default: true
      todo_planner:
        description: 'Todo/Planner (~237KB)'
        required: false
        type: boolean
        default: false
      dark_mode:
        description: 'Dark Mode (~0KB base)'
        required: false
        type: boolean
        default: true
      visual_cover_picker:
        description: 'Visual Cover Picker (~12KB)'
        required: false
        type: boolean
        default: false
      ble_wifi_provisioning:
        description: 'BLE WiFi Provisioning (~150KB)'
        required: false
        type: boolean
        default: false
      user_fonts:
        description: 'User Fonts from SD (~10KB)'
        required: false
        type: boolean
        default: true
      web_wifi_setup:
        description: 'Web WiFi Setup (~4KB)'
        required: false
        type: boolean
        default: true

jobs:
  build-custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen

      - name: Ensure pip for PlatformIO
        run: |
          uv run python -m ensurepip --upgrade || true
          uv run python -m pip --version

      - name: Generate custom build configuration
        id: config
        run: |
          # Build the command based on profile or individual plugins
          if [ "${{ inputs.profile }}" != "custom" ]; then
            echo "Using profile: ${{ inputs.profile }}"
            uv run python scripts/generate_build_config.py --profile "${{ inputs.profile }}"
          else
            echo "Using custom plugin selection"
            CMD=(uv run python scripts/generate_build_config.py)

            # Add enabled plugins
            if [ "${{ inputs.extended_fonts }}" == "true" ]; then
              CMD+=(--enable extended_fonts)
            fi
            if [ "${{ inputs.opendyslexic_fonts }}" == "true" ]; then
              CMD+=(--enable opendyslexic_fonts)
            fi
            if [ "${{ inputs.image_sleep }}" == "true" ]; then
              CMD+=(--enable image_sleep)
            fi
            if [ "${{ inputs.markdown }}" == "true" ]; then
              CMD+=(--enable markdown)
            fi
            if [ "${{ inputs.integrations }}" == "true" ]; then
              CMD+=(--enable integrations)
            fi
            if [ "${{ inputs.koreader_sync }}" == "true" ]; then
              CMD+=(--enable koreader_sync)
            fi
            if [ "${{ inputs.calibre_sync }}" == "true" ]; then
              CMD+=(--enable calibre_sync)
            fi
            if [ "${{ inputs.background_server }}" == "true" ]; then
              CMD+=(--enable background_server)
            fi
            if [ "${{ inputs.home_media_picker }}" == "true" ]; then
              CMD+=(--enable home_media_picker)
            fi
            if [ "${{ inputs.web_pokedex_plugin }}" == "true" ]; then
              CMD+=(--enable web_pokedex_plugin)
            fi
            if [ "${{ inputs.epub_support }}" == "true" ]; then
              CMD+=(--enable epub_support)
            fi
            if [ "${{ inputs.hyphenation }}" == "true" ]; then
              CMD+=(--enable hyphenation)
            fi
            if [ "${{ inputs.xtc_support }}" == "true" ]; then
              CMD+=(--enable xtc_support)
            fi
            if [ "${{ inputs.lyra_theme }}" == "true" ]; then
              CMD+=(--enable lyra_theme)
            fi
            if [ "${{ inputs.ota_updates }}" == "true" ]; then
              CMD+=(--enable ota_updates)
            fi
            if [ "${{ inputs.todo_planner }}" == "true" ]; then
              CMD+=(--enable todo_planner)
            fi
            if [ "${{ inputs.dark_mode }}" == "true" ]; then
              CMD+=(--enable dark_mode)
            fi
            if [ "${{ inputs.visual_cover_picker }}" == "true" ]; then
              CMD+=(--enable visual_cover_picker)
            fi
            if [ "${{ inputs.ble_wifi_provisioning }}" == "true" ]; then
              CMD+=(--enable ble_wifi_provisioning)
            fi
            if [ "${{ inputs.user_fonts }}" == "true" ]; then
              CMD+=(--enable user_fonts)
            fi
            if [ "${{ inputs.web_wifi_setup }}" == "true" ]; then
              CMD+=(--enable web_wifi_setup)
            fi

            # Execute the command
            "${CMD[@]}"
          fi

          # Show generated configuration
          echo "Generated configuration:"
          cat platformio-custom.ini

      - name: Build custom firmware
        run: uv run pio run -e custom | tee pio-custom.log

      - name: Enforce flash headroom
        run: |
          uv run python scripts/check_flash_headroom.py \
            --log pio-custom.log \
            --firmware .pio/build/custom/firmware.bin \
            --min-headroom-kb 64

      - name: Report firmware size
        run: |
          echo "### Custom Firmware Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.profile }}" != "custom" ]; then
            echo "**Profile:** ${{ inputs.profile }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Profile:** custom" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Plugins:**" >> $GITHUB_STEP_SUMMARY
            echo "- Extended Fonts: ${{ inputs.extended_fonts }}" >> $GITHUB_STEP_SUMMARY
            echo "- OpenDyslexic: ${{ inputs.opendyslexic_fonts }}" >> $GITHUB_STEP_SUMMARY
            echo "- PNG/JPEG/BMP Sleep: ${{ inputs.image_sleep }}" >> $GITHUB_STEP_SUMMARY
            echo "- Markdown: ${{ inputs.markdown }}" >> $GITHUB_STEP_SUMMARY
            echo "- Integrations: ${{ inputs.integrations }}" >> $GITHUB_STEP_SUMMARY
            echo "- KOReader Sync: ${{ inputs.koreader_sync }}" >> $GITHUB_STEP_SUMMARY
            echo "- Calibre Sync: ${{ inputs.calibre_sync }}" >> $GITHUB_STEP_SUMMARY
            echo "- Background Server: ${{ inputs.background_server }}" >> $GITHUB_STEP_SUMMARY
            echo "- Home Media Picker: ${{ inputs.home_media_picker }}" >> $GITHUB_STEP_SUMMARY
            echo "- Web Pokedex: ${{ inputs.web_pokedex_plugin }}" >> $GITHUB_STEP_SUMMARY
            echo "- EPUB Support: ${{ inputs.epub_support }}" >> $GITHUB_STEP_SUMMARY
            echo "- Hyphenation: ${{ inputs.hyphenation }}" >> $GITHUB_STEP_SUMMARY
            echo "- XTC Support: ${{ inputs.xtc_support }}" >> $GITHUB_STEP_SUMMARY
            echo "- Lyra Theme: ${{ inputs.lyra_theme }}" >> $GITHUB_STEP_SUMMARY
            echo "- OTA Updates: ${{ inputs.ota_updates }}" >> $GITHUB_STEP_SUMMARY
            echo "- Todo Planner: ${{ inputs.todo_planner }}" >> $GITHUB_STEP_SUMMARY
            echo "- Dark Mode: ${{ inputs.dark_mode }}" >> $GITHUB_STEP_SUMMARY
            echo "- Visual Cov Picker: ${{ inputs.visual_cover_picker }}" >> $GITHUB_STEP_SUMMARY
            echo "- BLE WiFi: ${{ inputs.ble_wifi_provisioning }}" >> $GITHUB_STEP_SUMMARY
            echo "- User Fonts: ${{ inputs.user_fonts }}" >> $GITHUB_STEP_SUMMARY
            echo "- Web WiFi Setup: ${{ inputs.web_wifi_setup }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Firmware Size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ -f ".pio/build/custom/firmware.bin" ]; then
            SIZE=$(stat -c%s ".pio/build/custom/firmware.bin")
            SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
            ls -lh ".pio/build/custom/firmware.bin" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Firmware size: ${SIZE_MB}MB / 6.4MB available" >> $GITHUB_STEP_SUMMARY

            # Calculate percentage
            PERCENT=$(echo "scale=1; $SIZE_MB * 100 / 6.4" | bc)
            echo "Flash usage: ${PERCENT}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "ERROR: No firmware.bin found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo '```ini' >> $GITHUB_STEP_SUMMARY
          cat platformio-custom.ini >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Flash headroom threshold: 64 KiB" >> $GITHUB_STEP_SUMMARY

      - name: Upload custom firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: custom-firmware
          path: |
            .pio/build/custom/firmware.bin
            .pio/build/custom/partitions.bin
            platformio-custom.ini
          retention-days: 30

      - name: Build summary
        run: |
          echo "âœ… Custom firmware build complete!"
          echo ""
          echo "Download the artifact from the Actions tab to get your custom firmware."
          echo "Flash using: esptool.py write_flash 0x10000 firmware.bin"
